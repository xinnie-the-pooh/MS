<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lh_core/fragment.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fragment.h File Reference</h1><code>#include "Defines.h"</code><br>
<code>#include "GenLuts.h"</code><br>

<p>
<a href="../../d2/d6/lh__core_2fragment_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a0">InvertLut1d</a> (<a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *LookUpTable, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a> AdressBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a1">CombiMatrix</a> (<a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> srcColorantData[3], <a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> destColorantData[3], double resMatrix[3][3])</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a2">doubMatrixInvert</a> (double MatHin[3][3], double MatRueck[3][3])</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a3">Fill_ushort_ELUT_identical</a> (<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a7">UINT16</a> *usELUT, char addrBits, char usedBits, long gridPoints)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a4">Fill_ushort_ELUT_from_CurveTag</a> (<a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *pCurveTag, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a7">UINT16</a> *usELUT, char addrBits, char usedBits, long gridPoints)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a5">Fill_inverse_byte_ALUT_from_CurveTag</a> (<a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *pCurveTag, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a> *ucALUT, char addrBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a6">Fill_inverse_ushort_ALUT_from_CurveTag</a> (<a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *pCurveTag, unsigned short *usALUT, char addrBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a7">Fill_ushort_ELUTs_from_lut8Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileELuts, char addrBits, char usedBits, long gridPoints)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a8">Fill_byte_ALUTs_from_lut8Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileALuts, char addrBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a9">Fill_ushort_ALUTs_from_lut8Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileALuts, char addrBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a10">Fill_ushort_ELUTs_from_lut16Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileELuts, char addrBits, char usedBits, long gridPoints, long inputTableEntries)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a11">Fill_byte_ALUTs_from_lut16Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileALuts, char addrBits, long outputTableEntries)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a12">Fill_ushort_ALUTs_from_lut16Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileALuts, char addrBits, long outputTableEntries)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a13">MakeGamut16or32ForMonitor</a> (<a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *pRedXYZ, <a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *pGreenXYZ, <a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *pBlueXYZ, <a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a> cube32Flag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lh__core_2fragment_8h.html#a14">DoAbsoluteShiftForPCS_Cube16</a> (unsigned short *theCube, long count, <a class="el" href="../../d2/d6/lh__open_2pi__app_8h.html#a13">CMProfileRef</a> theProfile, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a> pcsIsXYZ, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a> afterInput)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="lh_core/fragment.h::CombiMatrix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> CombiMatrix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>srcColorantData</em>[3], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>destColorantData</em>[3], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>double&nbsp;</td>
          <td class="mdname" nowrap> <em>resMatrix</em>[3][3]</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00317">317</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>00320 {
00321         <span class="keywordtype">short</span>           i, j;
00322         <span class="keywordtype">double</span>          straightMat[3][3], invMat[3][3];
00323         <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>         err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00324 
00325         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"CombiMatrix"</span>)
00326                 <span class="comment">/* RGB -&gt; XYZ for first profile: */</span>
00327         straightMat[0][0] = (<span class="keywordtype">double</span>)srcColorantData[0].data.data[0].X;
00328         straightMat[1][0] = (<span class="keywordtype">double</span>)srcColorantData[0].data.data[0].Y;
00329         straightMat[2][0] = (<span class="keywordtype">double</span>)srcColorantData[0].data.data[0].Z;
00330         
00331         straightMat[0][1] = (<span class="keywordtype">double</span>)srcColorantData[1].data.data[0].X;
00332         straightMat[1][1] = (<span class="keywordtype">double</span>)srcColorantData[1].data.data[0].Y;
00333         straightMat[2][1] = (<span class="keywordtype">double</span>)srcColorantData[1].data.data[0].Z;
00334         
00335         straightMat[0][2] = (<span class="keywordtype">double</span>)srcColorantData[2].data.data[0].X;
00336         straightMat[1][2] = (<span class="keywordtype">double</span>)srcColorantData[2].data.data[0].Y;
00337         straightMat[2][2] = (<span class="keywordtype">double</span>)srcColorantData[2].data.data[0].Z;
00338         
00339                 <span class="comment">/* RGB -&gt; XYZ for 2nd profile, store in resMatrix prelim.: */</span>
00340         resMatrix[0][0] = (<span class="keywordtype">double</span>)destColorantData[0].data.data[0].X;
00341         resMatrix[1][0] = (<span class="keywordtype">double</span>)destColorantData[0].data.data[0].Y;
00342         resMatrix[2][0] = (<span class="keywordtype">double</span>)destColorantData[0].data.data[0].Z;
00343         
00344         resMatrix[0][1] = (<span class="keywordtype">double</span>)destColorantData[1].data.data[0].X;
00345         resMatrix[1][1] = (<span class="keywordtype">double</span>)destColorantData[1].data.data[0].Y;
00346         resMatrix[2][1] = (<span class="keywordtype">double</span>)destColorantData[1].data.data[0].Z;
00347         
00348         resMatrix[0][2] = (<span class="keywordtype">double</span>)destColorantData[2].data.data[0].X;
00349         resMatrix[1][2] = (<span class="keywordtype">double</span>)destColorantData[2].data.data[0].Y;
00350         resMatrix[2][2] = (<span class="keywordtype">double</span>)destColorantData[2].data.data[0].Z;
00351         
00352         if( !doubMatrixInvert(resMatrix, invMat) )
00353         {
00354 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00355 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( DebugCheck(kThisFile, kDebugErrorInfo) )
00356             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(<span class="stringliteral">"¥ CombiMatrix-Error: doubMatrixInvert failed \n"</span>);
00357 <span class="preprocessor">#endif</span>
00358 <span class="preprocessor"></span>                err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00359                 <span class="keywordflow">goto</span> CleanupAndExit;
00360         }
00361         
00362         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)
00363                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00364                         resMatrix[i][j] = straightMat[i][0] * invMat[0][j]
00365                                                         + straightMat[i][1] * invMat[1][j]
00366                                                         + straightMat[i][2] * invMat[2][j];
00367 CleanupAndExit:
00368         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"CombiMatrix"</span>)
00369         return err;
00370 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="lh_core/fragment.h::DoAbsoluteShiftForPCS_Cube16" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> DoAbsoluteShiftForPCS_Cube16           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>theCube</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a13">CMProfileRef</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theProfile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcsIsXYZ</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>afterInput</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html#l00518">518</a> of file <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html">lh_core/frgmnt16.c</a>.
<p>
<pre class="fragment"><div>00523 {
00524         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           i, uLong;
00525         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>          *usPtr;
00526    <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                              err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00527         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           elementSize;
00528         <a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a>                       curMediaWhite;
00529         <span class="keywordtype">double</span>                          xFactor, yFactor, zFactor;
00530         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           intFactorX, intFactorY, intFactorZ;
00531         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           roundX, roundY, roundZ;
00532         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           shiftX, shiftY, shiftZ;
00533         
00534         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"DoAbsoluteShiftForPCS_Cube16"</span>)
00535         
00536         elementSize = sizeof(<a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a>);
00537         err = CMGetProfileElement(theProfile, icSigMediaWhitePointTag, &amp;elementSize, &amp;curMediaWhite);
00538 #ifdef IntelMode
00539    SwapLongOffset( &amp;curMediaWhite.base.sig, 0, 4 );
00540    SwapLongOffset( &amp;curMediaWhite, (LONG)((<span class="keywordtype">char</span>*)&amp;curMediaWhite.data.data[0]-(<span class="keywordtype">char</span>*)&amp;curMediaWhite), elementSize );
00541 #endif
00542         if(err)
00543         {
00544                 <span class="keywordflow">if</span>(err == <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a38">cmElementTagNotFound</a>)         <span class="comment">/* take D50 and do nothing */</span>
00545                         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00546                 <span class="keywordflow">else</span>
00547                         <span class="keywordflow">return</span>(err);
00548         }
00549         
00550                 <span class="comment">/*--- preliminary matching factors: ---*/</span>
00551         xFactor = ((<span class="keywordtype">double</span>)curMediaWhite.<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>) / 65536. / 0.9642;
00552         <span class="keywordflow">if</span>(xFactor &gt; 100.)
00553                 xFactor = 100.;                 <span class="comment">/* evil profile */</span>
00554         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(xFactor &lt; 0.01)
00555                 xFactor = 0.01;
00556 
00557         yFactor = ((<span class="keywordtype">double</span>)curMediaWhite.<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>) / 65536.;
00558         <span class="keywordflow">if</span>(yFactor &gt; 100.)
00559                 yFactor = 100.;
00560         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(yFactor &lt; 0.01)
00561                 yFactor = 0.01;
00562 
00563         zFactor = ((<span class="keywordtype">double</span>)curMediaWhite.<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>) / 65536. / 0.8249;
00564         <span class="keywordflow">if</span>(zFactor &gt; 100.)
00565                 zFactor = 100.;
00566         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(zFactor &lt; 0.01)
00567                 zFactor = 0.01;
00568 
00569         <span class="keywordflow">if</span>( ( xFactor &lt; 1.+1.E-3 &amp;&amp; xFactor &gt; 1.-1.E-3 ) &amp;&amp;
00570                 ( yFactor &lt; 1.+1.E-3 &amp;&amp; yFactor &gt; 1.-1.E-3 ) &amp;&amp;
00571                 ( zFactor &lt; 1.+1.E-3 &amp;&amp; zFactor &gt; 1.-1.E-3 ) )
00572                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>; <span class="comment">/* do nothing if MediaWhite is D50 */</span>
00573         
00574         <span class="keywordflow">if</span>(!afterInput)         <span class="comment">/* back to device space (for example with B2A1 table) */</span>
00575         {
00576                 xFactor = 1. / xFactor;
00577                 yFactor = 1. / yFactor;
00578                 zFactor = 1. / zFactor;
00579         }
00580         
00581                 <span class="comment">/*--- integer factors for speed: ---*/</span>
00582         intFactorX = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(xFactor * 65536. * 64.);   <span class="comment">/* probably too long... */</span>
00583         intFactorY = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(yFactor * 65536. * 64.);   <span class="comment">/* ...adding 22 bits    */</span>
00584         intFactorZ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(zFactor * 65536. * 64.);
00585         
00586         roundX = roundY = roundZ = 0x1FFFFF;    <span class="comment">/* 2^21 - 1 */</span>
00587         shiftX = shiftY = shiftZ = 22;
00588         
00589         <span class="keywordflow">while</span>(intFactorX &amp; 0xFFFF0000)  <span class="comment">/* stay within 16 bits to prevent product overflow */</span>
00590         {
00591                 intFactorX &gt;&gt;= 1;
00592                 roundX     &gt;&gt;= 1;
00593                 shiftX      -= 1;
00594         }
00595         
00596         <span class="keywordflow">while</span>(intFactorY &amp; 0xFFFF0000)
00597         {
00598                 intFactorY &gt;&gt;= 1;
00599                 roundY     &gt;&gt;= 1;
00600                 shiftY      -= 1;
00601         }
00602         
00603         <span class="keywordflow">while</span>(intFactorZ &amp; 0xFFFF0000)
00604         {
00605                 intFactorZ &gt;&gt;= 1;
00606                 roundZ     &gt;&gt;= 1;
00607                 shiftZ      -= 1;
00608         }
00609         
00610                 <span class="comment">/*--- perform matching: ---*/</span>
00611         <span class="keywordflow">if</span>(!pcsIsXYZ)           <span class="comment">/* 16 bit linear Lab  to XYZ before and afterwards */</span>
00612                 <a class="code" href="../../d1/d6/w98_2lh__core_2stdconv_8h.html#a0">Lab2XYZ_forCube16</a>(theCube, count);
00613         
00614         usPtr = theCube;
00615 
00616         <span class="keywordflow">for</span>(i=0; i&lt;(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)count; i++)
00617         {
00618                 uLong = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*usPtr) * intFactorX + roundX) &gt;&gt; shiftX;
00619                 <span class="keywordflow">if</span>(uLong &gt; 0x0FFFF)
00620                         uLong = 0xFFFF;                         <span class="comment">/* clip to 2.0 */</span>
00621                 *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)uLong;
00622                 
00623                 uLong = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*usPtr) * intFactorY + roundY) &gt;&gt; shiftY;
00624                 <span class="keywordflow">if</span>(uLong &gt; 0x0FFFF)
00625                         uLong = 0xFFFF;
00626                 *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)uLong;
00627                 
00628                 uLong = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*usPtr) * intFactorZ + roundZ) &gt;&gt; shiftZ;
00629                 <span class="keywordflow">if</span>(uLong &gt; 0x0FFFF)
00630                         uLong = 0xFFFF;
00631                 *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)uLong;
00632         }
00633 
00634         <span class="keywordflow">if</span>(!pcsIsXYZ)           <span class="comment">/* back to 16 bit Lab */</span>
00635                 <a class="code" href="../../d1/d6/w98_2lh__core_2stdconv_8h.html#a1">XYZ2Lab_forCube16</a>(theCube, count);
00636 
00637 
00638         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"DoAbsoluteShiftForPCS_Cube16"</span>)
00639         return(noErr);
00640 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lh_core/fragment.h::doubMatrixInvert" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a> doubMatrixInvert           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">double&nbsp;</td>
          <td class="mdname" nowrap> <em>MatHin</em>[3][3], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>double&nbsp;</td>
          <td class="mdname" nowrap> <em>MatRueck</em>[3][3]</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00389">389</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>00390 {
00391         <span class="keywordtype">double</span>  detm, hilf1, hilf2, hilf3, hilf4, hilf5, hilf6;
00392         <span class="keywordtype">double</span>  *a;
00393         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00394 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00395 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> err=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00396 <span class="preprocessor">#endif</span>
00397 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"doubMatrixInvert"</span>)
00398         a = (<span class="keywordtype">double</span> *)MatHin;
00399         
00400         hilf1 = a[0] * a[4];
00401         hilf2 = a[1] * a[5];
00402         hilf3 = a[2] * a[3];
00403         hilf4 = a[2] * a[4];
00404         hilf5 = a[1] * a[3];
00405         hilf6 = a[0] * a[5];
00406         
00407         detm = hilf1 * a[8] + hilf2 * a[6]
00408                  + hilf3 * a[7] - hilf4 * a[6]
00409                  - hilf5 * a[8] - hilf6 * a[7];
00410         
00411         <span class="comment">/*      if(fabs(detm) &lt; 1.E-9) */</span>
00412         if ( (detm &lt; 1.E-9) &amp;&amp; (detm &gt; -1.E-9) )
00413         success = FALSE;
00414         else
00415         {
00416                 detm = 1. / detm;
00417                 
00418                 MatRueck[0][0] = (a[4] * a[8] - a[5] * a[7]) * detm;
00419                 MatRueck[0][1] = (a[7] * a[2] - a[8] * a[1]) * detm;
00420                 MatRueck[0][2] = (hilf2       - hilf4      ) * detm;
00421         
00422                 MatRueck[1][0] = (a[5] * a[6] - a[3] * a[8]) * detm;
00423                 MatRueck[1][1] = (a[8] * a[0] - a[6] * a[2]) * detm;
00424                 MatRueck[1][2] = (hilf3       - hilf6      ) * detm;
00425         
00426                 MatRueck[2][0] = (a[3] * a[7] - a[4] * a[6]) * detm;
00427                 MatRueck[2][1] = (a[6] * a[1] - a[7] * a[0]) * detm;
00428                 MatRueck[2][2] = (hilf1       - hilf5      ) * detm;
00429         }
00430         
00431         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"doubMatrixInvert"</span>)
00432     return(success);
00433 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="lh_core/fragment.h::Fill_byte_ALUTs_from_lut16Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_byte_ALUTs_from_lut16Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileALuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>outputTableEntries</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l01237">1237</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>01241 {
01242         <span class="keywordtype">long</span>                    i, j;
01243         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curOutLut;
01244         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curALUT;
01245         <span class="keywordtype">long</span>                    count, clipIndex, outTabLen;
01246         <span class="keywordtype">long</span>                    indFactor, fract, baseInd, lAux;
01247         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *profALUTs = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)profileALuts;
01248         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01249         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01250         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *localAlutPtr;
01251         <span class="keywordtype">long</span>                    theAlutSize;
01252         
01253         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut16Tag"</span>)
01254         
01255         count     = 1 &lt;&lt; addrBits;                                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
01256         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8));    <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
01257 
01258         theAlutSize = theLutData-&gt;colorLutOutDim * count;
01259         localAlut   = ALLOC_DATA(theAlutSize + 1, &amp;err);
01260         if (err)
01261                 goto CleanupAndExit;
01262         
01263         outTabLen = outputTableEntries;                                 <span class="comment">/* &lt;= 4096 */</span>
01264         indFactor = ((outTabLen - 1) &lt;&lt; 18) / clipIndex;        <span class="comment">/* for adjusting the indices */</span>
01265         
01266         LOCK_DATA(localAlut);
01267         localAlutPtr = (UINT8*)DATA_2_PTR(localAlut);
01268         
01269         for(i=0; i&lt;theLutData-&gt;colorLutOutDim; i++)
01270         {
01271                 curOutLut = profALUTs + i * outTabLen;
01272                 curALUT   = localAlutPtr + i * count;
01273                 
01274                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex; j++)
01275                 {
01276                         lAux    = (j * indFactor+32) &gt;&gt; 6;
01277                         baseInd = lAux &gt;&gt; 12;
01278                         fract   = lAux &amp; 0x0FFF;
01279                         
01280                         <span class="keywordflow">if</span>(fract)
01281                         {
01282                                 lAux = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1] - (<span class="keywordtype">long</span>)curOutLut[baseInd];
01283                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
01284                                 
01285                                 curALUT[j] = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>)(((<span class="keywordtype">long</span>)curOutLut[baseInd] + lAux) &gt;&gt; 8);
01286                         }
01287                         <span class="keywordflow">else</span>
01288                                 curALUT[j] = curOutLut[baseInd] &gt;&gt; 8;
01289                 }
01290                 
01291                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
01292                         curALUT[j] = curALUT[clipIndex];
01293         }
01294         
01295         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
01296         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
01297         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01298 CleanupAndExit:
01299         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
01300         
01301         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut16Tag"</span>)
01302         return err;
01303 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="lh_core/fragment.h::Fill_byte_ALUTs_from_lut8Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_byte_ALUTs_from_lut8Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileALuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l01028">1028</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>01031 {
01032         <span class="keywordtype">long</span>                    i, j;
01033         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curOutLut;
01034         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *profAluts = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)profileALuts;
01035         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curALUT;
01036         <span class="keywordtype">long</span>                    count, clipIndex;
01037         <span class="keywordtype">long</span>                    factor, fract, baseInd, lAux;
01038         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01039         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01040         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *localAlutPtr;
01041         <span class="keywordtype">long</span>                    theAlutSize;
01042         
01043         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut8Tag"</span>)
01044 
01045         count     = 1 &lt;&lt; addrBits;                                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
01046         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8));    <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
01047         
01048         theAlutSize = theLutData-&gt;colorLutOutDim * count;
01049         localAlut   = ALLOC_DATA(theAlutSize + 1, &amp;err);
01050         if (err)
01051                 goto CleanupAndExit;
01052         
01053         LOCK_DATA(localAlut);
01054         localAlutPtr = (UINT8*)DATA_2_PTR(localAlut);
01055         
01056         factor = (255 &lt;&lt; 12) / clipIndex;               <span class="comment">/* for adjusting the indices */</span>
01057         
01058         for(i=0; i&lt;theLutData-&gt;colorLutOutDim; i++)
01059         {
01060                 curOutLut = profAluts + (i &lt;&lt; 8);
01061                 curALUT   = localAlutPtr + i * count;
01062                 
01063                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex; j++)
01064                 {
01065                         lAux    = j * factor;
01066                         baseInd = lAux &gt;&gt; 12;
01067                         fract   = lAux &amp; 0x0FFF;
01068                         
01069                         <span class="keywordflow">if</span>(fract)
01070                         {
01071                                 lAux = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1] - (<span class="keywordtype">long</span>)curOutLut[baseInd];
01072                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
01073                                 
01074                                 curALUT[j] = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>)((<span class="keywordtype">long</span>)curOutLut[baseInd] + lAux);
01075                         }
01076                         <span class="keywordflow">else</span>
01077                                 curALUT[j] = curOutLut[baseInd];
01078                 }
01079                 
01080                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
01081                         curALUT[j] = curALUT[clipIndex];
01082         }
01083         
01084         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
01085         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
01086         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01087 CleanupAndExit:
01088         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
01089         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut8Tag"</span>)
01090         return err;
01091 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="lh_core/fragment.h::Fill_inverse_byte_ALUT_from_CurveTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_inverse_byte_ALUT_from_CurveTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pCurveTag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ucALUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="lh_core/fragment.h::Fill_inverse_ushort_ALUT_from_CurveTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_inverse_ushort_ALUT_from_CurveTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pCurveTag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>usALUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html#l00070">70</a> of file <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html">lh_core/frgmnt16.c</a>.
<p>
<pre class="fragment"><div>00073 {
00074         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, inCount, outCount, clipIndex, ulFactor;
00075         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   intpFirst, intpLast, halfStep, ulAux, target;
00076         <span class="keywordtype">short</span>                   monot;
00077         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *inCurve, *usPtr, *stopPtr;
00078         <span class="keywordtype">double</span>                  flFactor;
00079 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00080 <span class="preprocessor"></span>        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a> err=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00081 <span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_inverse_ushort_ALUT_from_CurveTag"</span>)
00083         
00084     if( pCurveTag-&gt;base.sig != icSigCurveType   <span class="comment">/* 'curv' */</span>
00085          || addrBits &gt; 15 )
00086          {
00087 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00088 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( DebugCheck(kThisFile, kDebugErrorInfo) )
00089                         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(<span class="stringliteral">"¥ Fill_inverse_ushort_ALUT_from_CurveTag ERROR:   addrBits= %d\n"</span>,addrBits);
00090 <span class="preprocessor">#endif</span>
00091 <span class="preprocessor"></span>                <span class="keywordflow">return</span>(<a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>);
00092          }
00093         
00094         outCount  = 1 &lt;&lt; addrBits;
00095         clipIndex = outCount - 1;
00096 
00097                 <span class="comment">/*---special cases:---*/</span>
00098 
00099         <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 0)         <span class="comment">/*---identity---*/</span>
00100         {
00101                 ulFactor = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)65535 &lt;&lt; 16) / clipIndex;            <span class="comment">/* use all 32 bits */</span>
00102                 
00103                 <span class="keywordflow">for</span>(i=0; i&lt;clipIndex; i++)
00104                         usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)((i * ulFactor + 32767) &gt;&gt; 16);
00105         
00106                 <span class="keywordflow">for</span>(i=clipIndex; i&lt;outCount; i++)
00107                         usALUT[i] = 0xFFFF;
00108         
00109                 <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00110         }
00111         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 1)    <span class="comment">/*---gamma curve---*/</span>
00112         {
00113                 <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a1">Fill_inverseGamma_ushort_ALUT</a>(usALUT, addrBits, pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>[0]);
00114                 <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00115         }
00116         
00117                 <span class="comment">/*---ordinary case:---*/</span>
00118         
00119         inCount = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a>;
00120         inCurve = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>;
00121                 
00122                  <span class="comment">/* exact matching factor needed for special values: */</span>
00123         flFactor = (<span class="keywordtype">double</span>)clipIndex / 65535.;
00124         
00125         halfStep = clipIndex &gt;&gt; 1;              <span class="comment">/* lessen computation incorrectness */</span>
00126         
00127                                 <span class="comment">/* ascending or descending ? */</span>
00128         <span class="keywordflow">for</span>(monot=0, i=1; i&lt;inCount; i++)
00129         {
00130                 <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00131                         monot++;
00132                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00133                         monot--;
00134         }
00135         
00136         <span class="keywordflow">if</span>(monot &gt;= 0)  <span class="comment">/* curve seems to be ascending */</span>
00137         {
00138                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00139                         <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00140                                 inCurve[i] = inCurve[i-1];      <span class="comment">/* correct not-invertible parts */</span>
00141                 
00142                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor + 0.9999);
00143                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor);
00144                 
00145                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00146                         usALUT[i] = 0;
00147                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00148                         usALUT[i] = 0xFFFF;
00149 
00150                         <span class="comment">/* interpolate remaining values: */</span>
00151                 usPtr   = inCurve;
00152                 stopPtr = inCurve + inCount - 2; <span class="comment">/* stops incrementation */</span>
00153                 
00154                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00155                 {
00156                         target = (0x0FFFF * i + halfStep)  / clipIndex;
00157                         <span class="keywordflow">while</span>(*(usPtr+1) &lt; target &amp;&amp; usPtr &lt; stopPtr)
00158                                 usPtr++;                                        <span class="comment">/* find interval */</span>
00159                         
00160                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr - inCurve) &lt;&lt; 16) / (inCount - 1);
00161                         <span class="keywordflow">if</span>(*(usPtr+1) != *usPtr)
00162                         {
00163                                 ulAux += ((target - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*usPtr) &lt;&lt; 16)
00164                                           / ( (*(usPtr+1) - *usPtr) * (inCount - 1) );
00165                                 
00166                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)   <span class="comment">/* *(usPtr+1) was required */</span>
00167                                         ulAux = 0xFFFF;
00168                         }
00169                         
00170                         usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00171                 }
00172         }
00173         <span class="keywordflow">else</span>                    <span class="comment">/* curve seems to be descending */</span>
00174         {
00175                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00176                         <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00177                                 inCurve[i] = inCurve[i-1];      <span class="comment">/* correct not-invertible parts */</span>
00178                 
00179                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor + 0.9999);
00180                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor);
00181                 
00182                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00183                         usALUT[i] = 0xFFFF;
00184                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00185                         usALUT[i] = 0;
00186 
00187                         <span class="comment">/* interpolate remaining values: */</span>
00188                 usPtr   = inCurve + inCount - 1;
00189                 stopPtr = inCurve + 1;          <span class="comment">/* stops decrementation */</span>
00190                 
00191                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00192                 {
00193                         target = (0x0FFFF * i + halfStep)  / clipIndex;
00194                         <span class="keywordflow">while</span>(*(usPtr-1) &lt; target &amp;&amp; usPtr &gt; stopPtr)
00195                                 usPtr--;                                        <span class="comment">/* find interval */</span>
00196                         
00197                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr-1 - inCurve) &lt;&lt; 16) / (inCount - 1);
00198                         <span class="keywordflow">if</span>(*(usPtr-1) != *usPtr)
00199                         {
00200                                 ulAux += (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*(usPtr-1) - target) &lt;&lt; 16)
00201                                           / ( (*(usPtr-1) - *usPtr) * (inCount - 1) );
00202                                 
00203                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)
00204                                         ulAux = 0xFFFF;
00205                         }
00206                         
00207                         usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00208                 }
00209         }
00210         
00211 
00212         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_inverse_ushort_ALUT_from_CurveTag"</span>)
00213         return(noErr);
00214 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="lh_core/fragment.h::Fill_ushort_ALUTs_from_lut16Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ALUTs_from_lut16Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileALuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>outputTableEntries</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html#l00414">414</a> of file <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html">lh_core/frgmnt16.c</a>.
<p>
<pre class="fragment"><div>00418 {
00419         <span class="keywordtype">long</span>                    i;
00420         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *curOutLut;
00421         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *curALUT;
00422         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   ulIndFactor, j;
00423         <span class="keywordtype">long</span>                    count, clipIndex, outTabLen;
00424         <span class="keywordtype">long</span>                    fract, baseInd, lAux, leftVal, rightVal;
00425         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *profALUTs = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)profileALuts;
00426         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00427         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00428         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *localAlutPtr;
00429         <span class="keywordtype">long</span>                    theAlutSize;
00430         
00431         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut16Tag"</span>)
00432         
00433         count     = 1 &lt;&lt; addrBits;                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
00434         clipIndex = count - 1;
00435 
00436         theAlutSize = theLutData-&gt;colorLutOutDim * count * sizeof(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>);
00437         localAlut   = ALLOC_DATA(theAlutSize + 2, &amp;err);
00438         if (err)
00439                 goto CleanupAndExit;
00440         
00441         outTabLen = outputTableEntries;                 <span class="comment">/* &lt;= 4096 acc. to the spec */</span>
00442         if(outTabLen &gt; 4096)
00443         {
00444                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00445                 <span class="keywordflow">goto</span> CleanupAndExit;
00446         }
00447         
00448         ulIndFactor = (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)outTabLen - 1) &lt;&lt; 20)
00449                                 / (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)clipIndex;                             <span class="comment">/* for adjusting the indices */</span>
00450         
00451         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localAlut);
00452         localAlutPtr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localAlut);
00453         
00454         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a>; i++)
00455         {
00456                 curOutLut = profALUTs + i * outTabLen;
00457                 curALUT   = localAlutPtr + i * count;
00458                 
00459                 <span class="keywordflow">for</span>(j=0; j&lt;=(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)clipIndex; j++)
00460                 {
00461                         lAux    = (<span class="keywordtype">long</span>)( (j * ulIndFactor + 16) &gt;&gt; 5 );                <span class="comment">/* n.b: j is unsigned long ! */</span>
00462                         baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 15;
00463                         fract   = lAux &amp; 0x7FFF;        <span class="comment">/* 15 bits for interpolation */</span>
00464                         
00465                         <span class="keywordflow">if</span>(fract)
00466                         {
00467                                 leftVal  = (<span class="keywordtype">long</span>)curOutLut[baseInd];
00468                                 rightVal = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1];
00469                                 
00470                                 lAux = rightVal - leftVal;
00471                                 lAux = (lAux * fract + 16383) &gt;&gt; 15;
00472                                 
00473                                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00474                         }
00475                         <span class="keywordflow">else</span>
00476                                 curALUT[j] = curOutLut[baseInd];
00477                 }
00478                 
00479                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)count; j++)         <span class="comment">/* unused indices, clip these */</span>
00480                         curALUT[j] = curALUT[clipIndex];
00481         }
00482         
00483         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
00484         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
00485         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00486 CleanupAndExit:
00487         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
00488 
00489         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut16Tag"</span>)
00490         return err;
00491 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="lh_core/fragment.h::Fill_ushort_ALUTs_from_lut8Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ALUTs_from_lut8Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileALuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html#l00316">316</a> of file <a class="el" href="../../d5/d6/lh__core_2frgmnt16_8c-source.html">lh_core/frgmnt16.c</a>.
<p>
<pre class="fragment"><div>00319 {
00320         <span class="keywordtype">long</span>                    i, j;
00321         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *curOutLut;
00322         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *profAluts = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)profileALuts;
00323         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *curALUT;
00324         <span class="keywordtype">long</span>                    count, clipIndex;
00325         <span class="keywordtype">long</span>                    factor, fract, baseInd, lAux, leftVal, rightVal;
00326         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00327         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00328         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *localAlutPtr;
00329         <span class="keywordtype">long</span>                    theAlutSize;
00330         
00331         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut8Tag"</span>)
00332         
00333         count     = 1 &lt;&lt; addrBits;                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
00334         clipIndex = count - 1;
00335         
00336         theAlutSize = theLutData-&gt;colorLutOutDim * count * sizeof(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>);
00337         localAlut   = ALLOC_DATA(theAlutSize + 2, &amp;err);
00338         if (err)
00339                 goto CleanupAndExit;
00340         
00341         LOCK_DATA(localAlut);
00342         localAlutPtr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)DATA_2_PTR(localAlut);
00343         
00344         factor = ((255 &lt;&lt; 12) + clipIndex/2) / clipIndex;               <span class="comment">/* for adjusting the indices */</span>
00345         
00346         for(i=0; i&lt;theLutData-&gt;colorLutOutDim; i++)
00347         {
00348                 curOutLut = profAluts + (i &lt;&lt; 8);               <span class="comment">/* these are unsigned char's */</span>
00349                 curALUT   = localAlutPtr + i * count;   <span class="comment">/* these are unsigned short's */</span>
00350                 
00351                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex-1; j++)
00352                 {
00353                         lAux    = j * factor;
00354                         baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 12;
00355                         fract   = lAux &amp; 0x0FFF;
00356                         
00357                         leftVal = (<span class="keywordtype">long</span>)curOutLut[baseInd];
00358                         leftVal = (leftVal &lt;&lt; 8) + leftVal;             <span class="comment">/* 0xFF -&gt; 0xFFFF */</span>
00359                         
00360                         <span class="keywordflow">if</span>(fract)
00361                         {
00362                                 rightVal = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1];
00363                                 rightVal = (rightVal &lt;&lt; 8) + rightVal;          <span class="comment">/* 0xFF -&gt; 0xFFFF */</span>
00364                                 
00365                                 lAux = rightVal - leftVal;
00366                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
00367                                 
00368                                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00369                         }
00370                         <span class="keywordflow">else</span>
00371                                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)leftVal;
00372                 }
00373                 
00374                 leftVal = (<span class="keywordtype">long</span>)curOutLut[255];
00375                 leftVal = (leftVal &lt;&lt; 8) + leftVal;             <span class="comment">/* 0xFF -&gt; 0xFFFF */</span>
00376                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)leftVal;
00377                 
00378                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
00379                         curALUT[j] = curALUT[clipIndex];
00380         }
00381         
00382         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
00383         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
00384         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00385 CleanupAndExit:
00386         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
00387 
00388         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut8Tag"</span>)
00389         return err;
00390 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="lh_core/fragment.h::Fill_ushort_ELUT_from_CurveTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUT_from_CurveTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pCurveTag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a7">UINT16</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>usELUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="lh_core/fragment.h::Fill_ushort_ELUT_identical" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUT_identical           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a7">UINT16</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>usELUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00558">558</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>00562 {
00563         <span class="keywordtype">long</span>            i, count, factor, maxOut;
00564         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>          *myWPtr;
00565 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00566 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00567 <span class="preprocessor">#endif</span>
00568 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_identical"</span>)
00569                 
00570         count  = 1 &lt;&lt; addrBits;
00571         
00572         if(gridPoints == 0)
00573                 maxOut = 65535;
00574         else
00575                 maxOut = ((1L &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00576         
00577         factor = (maxOut &lt;&lt; 14) / (count - 1);
00578         
00579         myWPtr = usELUT;
00580         for(i=0; i&lt;count; i++)
00581                 *myWPtr++ = (UINT16)((i * factor + 0x2000) &gt;&gt; 14);
00582         
00583         LH_END_PROC("Fill_ushort_ELUT_identical")
00584         return(noErr);
00585 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="lh_core/fragment.h::Fill_ushort_ELUTs_from_lut16Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUTs_from_lut16Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileELuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>inputTableEntries</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l01121">1121</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>01127 {
01128         <span class="keywordtype">long</span>                    i, j, inTabLen, maxOut;
01129         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curInLut;
01130         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curELUT;
01131         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *profELUT = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)profileELuts;
01132         <span class="keywordtype">long</span>                    count, outFactor, fract, lAux, diff;
01133         <span class="keywordtype">long</span>                    baseInd, indFactor;
01134         <span class="keywordtype">long</span>                    outRound, outShift, interpRound, interpShift;
01135         <span class="keywordtype">double</span>                  dFactor;
01136         <span class="keywordtype">long</span>                    theElutSize;
01137         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01138         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *localElutPtr;
01139         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01140 
01141         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut16Tag"</span>)
01142         
01143         count     = 1 &lt;&lt; addrBits;
01144         inTabLen  = inputTableEntries;
01145 
01146         theElutSize = theLutData-&gt;colorLutInDim * count * sizeof (UINT16);
01147         localElut   = ALLOC_DATA(theElutSize + 2, &amp;err);
01148         if(err)
01149                 goto CleanupAndExit;
01150         
01151         indFactor = ((inTabLen - 1) &lt;&lt; 18) / (count - 1);       <span class="comment">/* for adjusting indices */</span>
01152 
01153         if(gridPoints == 0)
01154                 maxOut = 65535;
01155         else
01156                 maxOut = ((1L &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
01157 
01158                 <span class="comment">/*-----find factor for the values that fits in 15 bits------*/</span>
01159                 <span class="comment">/* (product with 16 bit number must fit in 31 bit uns.long)     */</span>
01160                 <span class="comment">/* n.b: 512 &lt;= maxOut &lt;= 65535  in all possible cases           */</span>
01161         
01162         dFactor  = (<span class="keywordtype">double</span>)maxOut / 65535.;             <span class="comment">/* 65535 is max. curve value */</span>
01163         dFactor *= 4194304.;                                    <span class="comment">/* same as &lt;&lt; 22, certainly too much */</span>
01164         
01165         outFactor = (<span class="keywordtype">long</span>)dFactor;
01166         outRound  = (1L &lt;&lt; 21) - 1;
01167         outShift  = 22;
01168         while(outFactor &amp; 0xFFF8000)    <span class="comment">/* stay within 15 bits to prevent product overflow */</span>
01169         {
01170                 outFactor &gt;&gt;= 1;
01171                 outRound  &gt;&gt;= 1;
01172                 outShift   -= 1;
01173         }
01174         
01175         interpRound = outRound &gt;&gt; 1;    <span class="comment">/* with interpolation we have an additional...  */</span>
01176         interpShift = outShift  - 1;    <span class="comment">/* ... &gt;&gt; 1 because we must add two nunmbers    */</span>
01177         
01178         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localElut);
01179         localElutPtr = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localElut);
01180 
01181         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o6">colorLutInDim</a>; i++)
01182         {
01183                 curInLut = profELUT + (i * inTabLen);
01184                 curELUT  = localElutPtr + (i * count);
01185 
01186                 <span class="keywordflow">for</span>(j=0; j&lt;count; j++)
01187                 {
01188                         lAux    = (j * indFactor+4) &gt;&gt; 3;
01189                         baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 15;
01190                         fract   = lAux &amp; 0x7FFF;        <span class="comment">/* 15 bits for interpolation */</span>
01191 
01192                         <span class="keywordflow">if</span>(fract)               <span class="comment">/* interpolation necessary ? */</span>
01193                         {
01194                                 lAux = (<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor &gt;&gt; 1;
01195                                 
01196                                 diff = (<span class="keywordtype">long</span>)curInLut[baseInd+1] - (<span class="keywordtype">long</span>)curInLut[baseInd];
01197                                 diff = ((diff * outFactor &gt;&gt; 15) * fract) &gt;&gt; 1;
01198 
01199                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( (lAux + diff + interpRound) &gt;&gt; interpShift );
01200                         }
01201                         <span class="keywordflow">else</span>
01202                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( ((<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor
01203                                                                                                         + outRound) &gt;&gt; outShift );
01204                 }
01205         }
01206         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localElut);
01207         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a> = localElut;
01208         localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01209 CleanupAndExit: 
01210         localElut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localElut); 
01211         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut16Tag"</span>)
01212         return err;
01213 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="lh_core/fragment.h::Fill_ushort_ELUTs_from_lut8Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUTs_from_lut8Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileELuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00941">941</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>00946 {
00947         <span class="keywordtype">long</span>                    i, j, maxOut;
00948         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curInLut;
00949         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curELUT;
00950         <span class="keywordtype">long</span>                    count, indFactor, outFactor, baseInd, fract, lAux, diff;
00951         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00952         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *localElutPtr;
00953         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00954         <span class="keywordtype">long</span>                    theElutSize;
00955         
00956         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut8Tag"</span>)
00957         
00958         count       = 1 &lt;&lt; addrBits;
00959         theElutSize = theLutData-&gt;colorLutInDim * count * sizeof (UINT16);
00960         localElut   = ALLOC_DATA(theElutSize + 2, &amp;err);
00961         if (err)
00962                 goto CleanupAndExit;
00963         
00964         indFactor = (255 &lt;&lt; 12) / (count - 1);  <span class="comment">/* for adjusting indices */</span>
00965         
00966         if(gridPoints == 0)
00967                 maxOut = 65535;
00968         else
00969                 maxOut = ((1L &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00970         outFactor = (maxOut &lt;&lt; 12) / 255;                       <span class="comment">/* 255 is max. value from mft1 output lut */</span>
00971         
00972         LOCK_DATA(localElut);
00973         localElutPtr = (UINT16*)DATA_2_PTR(localElut);
00974         for(i=0; i&lt;theLutData-&gt;colorLutInDim; i++)
00975         {
00976                 curInLut = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)profileELuts + (i &lt;&lt; 8);
00977                 curELUT  = localElutPtr + i * count;
00978                 
00979                 <span class="keywordflow">for</span>(j=0; j&lt;count; j++)
00980                 {
00981                         lAux    = j * indFactor;
00982                         baseInd = lAux &gt;&gt; 12;
00983                         fract   = (lAux &amp; 0x0FFF) &gt;&gt; 4; <span class="comment">/* leaves 8 bits for interpolation as with distortion */</span>
00984 
00985                         <span class="keywordflow">if</span>(fract &amp;&amp; baseInd != 255)             <span class="comment">/* interpolation necessary ? */</span>
00986                         {
00987                                 lAux = (<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor &gt;&gt; 6;
00988                                 
00989                                 diff = (<span class="keywordtype">long</span>)curInLut[baseInd+1] - (<span class="keywordtype">long</span>)curInLut[baseInd];
00990                                 diff = (diff * outFactor &gt;&gt; 6) * fract &gt;&gt; 8;
00991 
00992                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( (lAux + diff + 32) &gt;&gt; 6 );
00993                         }
00994                         <span class="keywordflow">else</span>
00995                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( ((<span class="keywordtype">long</span>)curInLut[baseInd]
00996                                                                                                         * outFactor + 0x0800) &gt;&gt; 12 );
00997                 }
00998         }
00999         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localElut);
01000         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a> = localElut;
01001         localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01002 CleanupAndExit:
01003         localElut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localElut);
01004         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut8Tag"</span>)
01005         return err;
01006 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="lh_core/fragment.h::InvertLut1d" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a>* InvertLut1d           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>LookUpTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AdressBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00070">70</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>00072 {
00073         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, inCount, outCount;
00074         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   intpFirst, intpLast, halfStep, ulAux, target;
00075         <span class="keywordtype">short</span>                   monot;
00076         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *inCurve, *outCurve, *usPtr, *stopPtr;
00077         <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a>             *outCMcurve = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00078         <span class="keywordtype">double</span>                  flFactor;
00079         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00080         
00081         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"InvertLut1d"</span>)
00082         
00083         if( LookUpTable-&gt;base.sig != icSigCurveType     <span class="comment">/* 'curv' */</span> || AdressBits &gt; 15 )
00084                 goto CleanupAndExit;
00085         
00086         inCount  = LookUpTable-&gt;curve.count;
00087         inCurve  = LookUpTable-&gt;curve.data;
00088         outCount = 0x1 &lt;&lt; AdressBits;
00089                 
00090         outCMcurve = (<a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a> *)SmartNewPtr( sizeof(OSType)
00091                                                                           + 2 * sizeof(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)
00092                                                                           + outCount * sizeof(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), &amp;err );
00093         if(err)
00094                 goto CleanupAndExit;
00095         
00096         outCurve = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)outCMcurve-&gt;curve.data;
00097         
00098         outCMcurve-&gt;base.sig    = icSigCurveType;       <span class="comment">/* 'curv' */</span>
00099         outCMcurve-&gt;base.reserved[0] = 0x00;
00100         outCMcurve-&gt;base.reserved[1] = 0x00;
00101         outCMcurve-&gt;base.reserved[2] = 0x00;
00102         outCMcurve-&gt;base.reserved[3] = 0x00;
00103         outCMcurve-&gt;curve.count = outCount;
00104         
00105         if(inCount &lt; 2)         <span class="comment">/* 0 or 1 point in LUT */</span>
00106         {
00107                 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a1">InvLut1dExceptions</a>(inCurve, inCount, outCurve, AdressBits);
00108                 <span class="keywordflow">goto</span> CleanupAndExit;
00109         }
00110         
00111                  <span class="comment">/* exact matching factor for special values: */</span>
00112         flFactor = (<span class="keywordtype">double</span>)(outCount - 1) / 65535.;
00113         halfStep = outCount &gt;&gt; 1;               <span class="comment">/* lessen computation incorrectness */</span>
00114         
00115                                 <span class="comment">/* ascending or descending ? */</span>
00116         <span class="keywordflow">for</span>(monot=0, i=1; i&lt;inCount; i++)
00117         {
00118                 <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00119                         monot++;
00120                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00121                         monot--;
00122         }
00123         
00124         <span class="keywordflow">if</span>(monot &gt;= 0)  <span class="comment">/* curve seems to be ascending */</span>
00125         {
00126                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00127                         <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00128                                 inCurve[i] = inCurve[i-1];
00129                 
00130                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor + 0.9999);
00131                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor);
00132                 
00133                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00134                         outCurve[i] = 0;
00135                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00136                         outCurve[i] = 0xFFFF;
00137 
00138                         <span class="comment">/* interpolate remaining values: */</span>
00139                 usPtr   = inCurve;
00140                 stopPtr = inCurve + inCount - 2; <span class="comment">/* stops incrementation */</span>
00141                 
00142                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00143                 {
00144                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00145                         <span class="keywordflow">while</span>(*(usPtr+1) &lt; target &amp;&amp; usPtr &lt; stopPtr)
00146                                 usPtr++;                                        <span class="comment">/* find interval */</span>
00147                         
00148                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr - inCurve) &lt;&lt; 16) / (inCount - 1);
00149                         <span class="keywordflow">if</span>(*(usPtr+1) != *usPtr)
00150                         {
00151                                 ulAux += ((target - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*usPtr) &lt;&lt; 16)
00152                                           / ( (*(usPtr+1) - *usPtr) * (inCount - 1) );
00153                                 
00154                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)   <span class="comment">/* *(usPtr+1) was required */</span>
00155                                         ulAux = 0xFFFF;
00156                         }
00157                         
00158                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00159                 }
00160         }
00161         <span class="keywordflow">else</span>                    <span class="comment">/* curve seems to be descending */</span>
00162         {
00163                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00164                         <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00165                                 inCurve[i] = inCurve[i-1];
00166                 
00167                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor + 0.9999);
00168                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor);
00169                 
00170                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00171                         outCurve[i] = 0xFFFF;
00172                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00173                         outCurve[i] = 0;
00174 
00175                         <span class="comment">/* interpolate remaining values: */</span>
00176                 usPtr   = inCurve + inCount - 1;
00177                 stopPtr = inCurve + 1;          <span class="comment">/* stops decrementation */</span>
00178                 
00179                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00180                 {
00181                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00182                         <span class="keywordflow">while</span>(*(usPtr-1) &lt; target &amp;&amp; usPtr &gt; stopPtr)
00183                                 usPtr--;                                        <span class="comment">/* find interval */</span>
00184                         
00185                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr-1 - inCurve) &lt;&lt; 16) / (inCount - 1);
00186                         <span class="keywordflow">if</span>(*(usPtr-1) != *usPtr)
00187                         {
00188                                 ulAux += (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*(usPtr-1) - target) &lt;&lt; 16)
00189                                           / ( (*(usPtr-1) - *usPtr) * (inCount - 1) );
00190                                 
00191                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)
00192                                         ulAux = 0x0FFFF;
00193                         }
00194                         
00195                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00196                 }
00197         }
00198 CleanupAndExit:
00199         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"InvertLut1d"</span>)
00200         return(outCMcurve);
00201 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="lh_core/fragment.h::MakeGamut16or32ForMonitor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> MakeGamut16or32ForMonitor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pRedXYZ</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pGreenXYZ</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pBlueXYZ</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cube32Flag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l01334">1334</a> of file <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html">lh_core/fragment.c</a>.
<p>
<pre class="fragment"><div>01340 {
01341         <span class="keywordtype">double</span>                  XYZmatrix[3][3], RGBmatrix[3][3];
01342         <span class="keywordtype">double</span>                  sum, dFactor;
01343         <span class="keywordtype">long</span>                    i, j, k, gridPoints, planeCount, totalCount, longMat[9];
01344         <span class="keywordtype">long</span>                    longX, longY, longZ, longR, longG, longB;
01345         <span class="keywordtype">long</span>                    *lPtr, lFactor, maxOut;
01346         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *usPtr;
01347         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *XPtr;
01348         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempXLutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01349         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempELutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01350         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempALutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01351         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *tempXLut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01352         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *tempALut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01353         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *tempELut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01354         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  Levels[32];
01355         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01356         
01357         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"MakeGamut16or32ForMonitor"</span>)
01358         
01359         if(theLutData-&gt;inputLut != nil || theLutData-&gt;colorLut != nil || theLutData-&gt;outputLut != nil)
01360         {
01361                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
01362                 <span class="keywordflow">goto</span> CleanupAndExit;
01363         }
01364         
01365 
01366         <span class="comment">/*----------------------------------------------------------------------------------------- E */</span>
01367         tempELutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(adr_bereich_elut * 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) + 2, &amp;err);  <span class="comment">/* +2 extra space for Interpolation */</span>
01368         <span class="keywordflow">if</span>(err)
01369                 <span class="keywordflow">goto</span> CleanupAndExit;
01370         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempELutHdl);
01371         tempELut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempELutHdl);
01372         
01373 
01374   <span class="comment">/*----------------------------------------------------------------------------------------- X */</span>
01375         <span class="keywordflow">if</span>(cube32Flag)
01376                 gridPoints = 32;                        <span class="comment">/* for cube grid */</span>
01377         <span class="keywordflow">else</span>
01378                 gridPoints = 16;
01379         totalCount = gridPoints * gridPoints * gridPoints;
01380   totalCount += 1 + gridPoints + gridPoints * gridPoints; <span class="comment">/* extra space for Interpolation */</span>
01381 
01382 <span class="preprocessor">#ifdef ALLOW_MMX</span>
01383 <span class="preprocessor"></span>                        totalCount+=3;  <span class="comment">/* +1 for MMX 4 Byte access */</span>
01384 <span class="preprocessor">#endif</span>
01385 <span class="preprocessor"></span>
01386         tempXLutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(totalCount, &amp;err);
01387         <span class="keywordflow">if</span>(err)
01388                 <span class="keywordflow">goto</span> CleanupAndExit;
01389         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempXLutHdl);
01390         tempXLut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempXLutHdl);
01391         
01392         
01393   <span class="comment">/*----------------------------------------------------------------------------------------- A */</span>
01394         tempALutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(adr_bereich_alut + 1, &amp;err);   <span class="comment">/* +1 extra space for Interpolation */</span>
01395         <span class="keywordflow">if</span>(err)
01396                 <span class="keywordflow">goto</span> CleanupAndExit;
01397         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempALutHdl);
01398         tempALut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempALutHdl);
01399         
01400                 <span class="comment">/*---------fill 3 ELUTs for X, Y, Z (256 u.shorts each):--------------------*/</span>
01401                 <span class="comment">/* linear curve with clipping, slope makes white value  become                          */</span>
01402                 <span class="comment">/* max * 30.5/31 or max * 14.5/15, that is half of the last XLUT interval       */</span>
01403         <span class="keywordflow">if</span>(cube32Flag)
01404                 dFactor = 30.5 / 31.;
01405         <span class="keywordflow">else</span>
01406                 dFactor = 14.5 / 15.;
01407         
01408         maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (16 <span class="comment">/*usedBits*/</span> - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
01409         
01410         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)              <span class="comment">/* X, Y, Z ELUTs */</span>
01411         {
01412                 <span class="keywordflow">if</span>(i == 0)
01413                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255. / 0.9642 );<span class="comment">/* X, adjust D50 */</span>
01414                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(i == 1)
01415                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255.);                 <span class="comment">/* Y */</span>
01416                 <span class="keywordflow">else</span>
01417                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255. / 0.8249);<span class="comment">/* Z, adjust D50 */</span>
01418                 
01419                 usPtr = tempELut + 256 * i;
01420                 <span class="keywordflow">for</span>(j=0; j&lt;256; j++)
01421                 {
01422                         k = (j * lFactor + 127) &gt;&gt; 8;
01423                         <span class="keywordflow">if</span>(k &gt; maxOut)
01424                                 k = maxOut;             <span class="comment">/* max. ELUT value */</span>
01425                         
01426                         *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)k;
01427                 }
01428         }
01429 
01430                 <span class="comment">/*------ RGB to XYZ matrix in the range 0.0 to 1.0 -----*/</span>
01431                 <span class="comment">/* floating point for accurate inversion                                */</span>
01432         XYZmatrix[0][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01433         XYZmatrix[1][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01434         XYZmatrix[2][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01435 
01436         XYZmatrix[0][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01437         XYZmatrix[1][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01438         XYZmatrix[2][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01439 
01440         XYZmatrix[0][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01441         XYZmatrix[1][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01442         XYZmatrix[2][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01443         
01444                 <span class="comment">/*--- grey with R = G = B (D50 adjustment is done by the ELUTs) ----*/</span>
01445         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)
01446         {
01447                 sum = XYZmatrix[i][0] + XYZmatrix[i][1] + XYZmatrix[i][2];
01448                 <span class="keywordflow">if</span>(sum &lt; 0.1)
01449                         sum = 0.1;      <span class="comment">/* prevent from div. by 0 (bad profiles) */</span>
01450                 
01451                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
01452                         XYZmatrix[i][j] /= sum;
01453         }
01454         
01455                 <span class="comment">/*---XYZ to RGB matrix:---*/</span>
01456         <span class="keywordflow">if</span>(!<a class="code" href="../../d1/d6/w98_2lh__core_2memlink_8c.html#a24">doubMatrixInvert</a>(XYZmatrix, RGBmatrix))
01457         {
01458                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
01459                 <span class="keywordflow">goto</span> CleanupAndExit;
01460         }
01461         
01462         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)                              <span class="comment">/* create integer format for speed, */</span>
01463                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)                      <span class="comment">/* 1.0 becomes 2^13, works for coeff. up to 8. */</span>
01464                         longMat[3*i + j] = (<span class="keywordtype">long</span>)(RGBmatrix[i][j] * 8192.);
01465         
01466                 <span class="comment">/*-----grid levels for cube grid in XYZ (16 bit) so ----*/</span>
01467                 <span class="comment">/* that white is at half of last interval, so the last  */</span>
01468                 <span class="comment">/* value is white * 15/14.5 or white * 31/30.5                  */</span>
01469         <span class="keywordflow">if</span>(cube32Flag)
01470                 dFactor = 32768. / 30.5 * 31. / (gridPoints - 1);
01471         <span class="keywordflow">else</span>
01472                 dFactor = 32768. / 14.5 * 15. / (gridPoints - 1);
01473 
01474         <span class="keywordflow">for</span>(i=0; i&lt;gridPoints; i++)                     <span class="comment">/* n.b: 32 is max. possible gridPoints */</span>
01475                 Levels[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(i * dFactor + 0.5);
01476         
01477                 <span class="comment">/*----special treatment of first and last plane for speed:----*/</span>
01478         planeCount = gridPoints * gridPoints;
01479         XPtr       = tempXLut;
01480         <span class="keywordflow">for</span>(i=0; i&lt;planeCount; i++)
01481                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01482         
01483         XPtr = tempXLut + (gridPoints - 1) * planeCount;
01484         <span class="keywordflow">for</span>(i=0; i&lt;planeCount; i++)
01485                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01486         
01487         *tempXLut = 0;  <span class="comment">/* set black (white is between last 2 planes) */</span>
01488 
01489                 <span class="comment">/*----second to second last plane must be computed:-----*/</span>
01490                 <span class="comment">/*  transform points to RGB and judge in/out                    */</span>
01491         XPtr = tempXLut + planeCount;
01492                 
01493         <span class="keywordflow">for</span>(i=1; i&lt;gridPoints-1; i++)
01494                 <span class="keywordflow">for</span>(j=0; j&lt;gridPoints; j++)
01495                         <span class="keywordflow">for</span>(k=0; k&lt;gridPoints; k++)
01496                         {
01497                                 longX = (<span class="keywordtype">long</span>)Levels[i];                <span class="comment">/* X */</span>
01498                                 longY = (<span class="keywordtype">long</span>)Levels[j];                <span class="comment">/* Y */</span>
01499                                 longZ = (<span class="keywordtype">long</span>)Levels[k];                <span class="comment">/* Z */</span>
01500                                 
01501                                         <span class="comment">/* matrix coeff: 2^13 is 1.0 , XYZ values: 1.0 or 100. is 2^15 ;        */</span>
01502                                         <span class="comment">/* -&gt; mask for products &lt; 0 and &gt;= 2^28 is used for in/out checking     */</span>
01503                                 
01504                                 longR = longX * longMat[0] + longY * longMat[1] + longZ * longMat[2];
01505                                 <span class="keywordflow">if</span>(longR &amp; 0xF0000000)
01506                                         *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01507                                 <span class="keywordflow">else</span>
01508                                 {
01509                                         longG = longX * longMat[3] + longY * longMat[4] + longZ * longMat[5];
01510                                         <span class="keywordflow">if</span>(longG &amp; 0xF0000000)
01511                                                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01512                                         <span class="keywordflow">else</span>
01513                                         {
01514                                                 longB = longX * longMat[6] + longY * longMat[7] + longZ * longMat[8];
01515                                                 <span class="keywordflow">if</span>(longB &amp; 0xF0000000)
01516                                                         *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01517                                                 <span class="keywordflow">else</span>
01518                                                         *XPtr++ = 0;            <span class="comment">/* in gamut */</span>
01519                                         }
01520                                 }
01521                         }
01522         
01523                 <span class="comment">/*---fill Boolean output LUT, adr_bereich_alut Bytes, 4 at one time with long:---*/</span>
01524         lPtr = (<span class="keywordtype">long</span> *)(tempALut);
01525         j = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a21">adr_bereich_alut</a>/4/2 + 8;   <span class="comment">/* slightly more than 50 % */</span>
01526         <span class="keywordflow">for</span>(i=0; i&lt;j; i++)                              <span class="comment">/* slightly more than 50 % */</span>
01527                 *(lPtr + i) = 0;                        <span class="comment">/* in gamut */</span>
01528         k = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a21">adr_bereich_alut</a>/4;
01529         <span class="keywordflow">for</span>(i=j; i&lt;k; i++)
01530                 *(lPtr + i) = 0xFFFFFFFF;       <span class="comment">/* out of gamut */</span>
01531         
01532         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempELutHdl);
01533         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempXLutHdl);
01534         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempALutHdl);
01535         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o10">colorLut</a>    = tempXLutHdl;  tempXLutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01536         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a>    = tempELutHdl;  tempELutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01537         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a>   = tempALutHdl;  tempALutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01538         
01539 CleanupAndExit:
01540         tempELutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempELutHdl);
01541         tempXLutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempXLutHdl);
01542         tempALutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempALutHdl);
01543         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"MakeGamut16or32ForMonitor"</span>)
01544         return (err);
01545 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
