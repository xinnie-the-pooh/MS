<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: w98/lh_core/fragment.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fragment.c File Reference</h1><code>#include "General.h"</code><br>
<code>#include &lt;math.h&gt;</code><br>
<code>#include "Fragment.h"</code><br>
<code>#include "StdConv.h"</code><br>

<p>
<a href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a0">CM_Doub</a>&nbsp;&nbsp;&nbsp;double</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a1">InvLut1dExceptions</a> (unsigned short *inCurve, unsigned long inCount, unsigned short *outCurve, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a> AdressBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a2">Fill_ushort_ELUT_Gamma</a> (unsigned short *usELUT, char addrBits, char usedBits, long gridPoints, unsigned short gamma_u8_8)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a3">Fill_inverseGamma_byte_ALUT</a> (unsigned char *ucALUT, char addrBits, unsigned short gamma_u8_8)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a4">InvertLut1d</a> (<a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *LookUpTable, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a> AdressBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a5">CombiMatrix</a> (<a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> srcColorantData[3], <a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> destColorantData[3], double resMatrix[3][3])</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a6">doubMatrixInvert</a> (double MatHin[3][3], double MatRueck[3][3])</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a7">Fill_ushort_ELUT_from_CurveTag</a> (<a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *pCurveTag, unsigned short *usELUT, char addrBits, char usedBits, long gridPoints)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a8">Fill_ushort_ELUT_identical</a> (<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a7">UINT16</a> *usELUT, char addrBits, char usedBits, long gridPoints)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a9">Fill_inverse_byte_ALUT_from_CurveTag</a> (<a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *pCurveTag, unsigned char *ucALUT, char addrBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a10">Fill_ushort_ELUTs_from_lut8Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileELuts, char addrBits, char usedBits, long gridPoints)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a11">Fill_byte_ALUTs_from_lut8Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileALuts, char addrBits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a12">Fill_ushort_ELUTs_from_lut16Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileELuts, char addrBits, char usedBits, long gridPoints, long inputTableEntries)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a13">Fill_byte_ALUTs_from_lut16Tag</a> (<a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> profileALuts, char addrBits, long outputTableEntries)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a14">MakeGamut16or32ForMonitor</a> (<a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *pRedXYZ, <a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *pGreenXYZ, <a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *pBlueXYZ, <a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a> theLutData, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a> cube32Flag)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="w98/lh_core/fragment.c::CM_Doub" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_Doub&nbsp;&nbsp;&nbsp;double          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00022">22</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="w98/lh_core/fragment.c::CombiMatrix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> CombiMatrix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>srcColorantData</em>[3], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>destColorantData</em>[3], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>double&nbsp;</td>
          <td class="mdname" nowrap> <em>resMatrix</em>[3][3]</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00317">317</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d3/d5/lh__open_2pi__app_8h-source.html#l00023">CMError</a>, <a class="el" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00541">icXYZArray::data</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00887">icXYZType::data</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00389">doubMatrixInvert()</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00534">icXYZNumber::X</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00535">icXYZNumber::Y</a>, and <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00536">icXYZNumber::Z</a>.
<p>
<pre class="fragment"><div>00320 {
00321         <span class="keywordtype">short</span>           i, j;
00322         <span class="keywordtype">double</span>          straightMat[3][3], invMat[3][3];
00323         <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>         err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00324 
00325         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"CombiMatrix"</span>)
00326                 <span class="comment">/* RGB -&gt; XYZ for first profile: */</span>
00327         straightMat[0][0] = (<span class="keywordtype">double</span>)srcColorantData[0].data.data[0].X;
00328         straightMat[1][0] = (<span class="keywordtype">double</span>)srcColorantData[0].data.data[0].Y;
00329         straightMat[2][0] = (<span class="keywordtype">double</span>)srcColorantData[0].data.data[0].Z;
00330         
00331         straightMat[0][1] = (<span class="keywordtype">double</span>)srcColorantData[1].data.data[0].X;
00332         straightMat[1][1] = (<span class="keywordtype">double</span>)srcColorantData[1].data.data[0].Y;
00333         straightMat[2][1] = (<span class="keywordtype">double</span>)srcColorantData[1].data.data[0].Z;
00334         
00335         straightMat[0][2] = (<span class="keywordtype">double</span>)srcColorantData[2].data.data[0].X;
00336         straightMat[1][2] = (<span class="keywordtype">double</span>)srcColorantData[2].data.data[0].Y;
00337         straightMat[2][2] = (<span class="keywordtype">double</span>)srcColorantData[2].data.data[0].Z;
00338         
00339                 <span class="comment">/* RGB -&gt; XYZ for 2nd profile, store in resMatrix prelim.: */</span>
00340         resMatrix[0][0] = (<span class="keywordtype">double</span>)destColorantData[0].data.data[0].X;
00341         resMatrix[1][0] = (<span class="keywordtype">double</span>)destColorantData[0].data.data[0].Y;
00342         resMatrix[2][0] = (<span class="keywordtype">double</span>)destColorantData[0].data.data[0].Z;
00343         
00344         resMatrix[0][1] = (<span class="keywordtype">double</span>)destColorantData[1].data.data[0].X;
00345         resMatrix[1][1] = (<span class="keywordtype">double</span>)destColorantData[1].data.data[0].Y;
00346         resMatrix[2][1] = (<span class="keywordtype">double</span>)destColorantData[1].data.data[0].Z;
00347         
00348         resMatrix[0][2] = (<span class="keywordtype">double</span>)destColorantData[2].data.data[0].X;
00349         resMatrix[1][2] = (<span class="keywordtype">double</span>)destColorantData[2].data.data[0].Y;
00350         resMatrix[2][2] = (<span class="keywordtype">double</span>)destColorantData[2].data.data[0].Z;
00351         
00352         if( !doubMatrixInvert(resMatrix, invMat) )
00353         {
00354 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00355 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( DebugCheck(kThisFile, kDebugErrorInfo) )
00356             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(<span class="stringliteral">"¥ CombiMatrix-Error: doubMatrixInvert failed \n"</span>);
00357 <span class="preprocessor">#endif</span>
00358 <span class="preprocessor"></span>                err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00359                 <span class="keywordflow">goto</span> CleanupAndExit;
00360         }
00361         
00362         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)
00363                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00364                         resMatrix[i][j] = straightMat[i][0] * invMat[0][j]
00365                                                         + straightMat[i][1] * invMat[1][j]
00366                                                         + straightMat[i][2] * invMat[2][j];
00367 CleanupAndExit:
00368         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"CombiMatrix"</span>)
00369         return err;
00370 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="w98/lh_core/fragment.c::doubMatrixInvert" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a> doubMatrixInvert           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">double&nbsp;</td>
          <td class="mdname" nowrap> <em>MatHin</em>[3][3], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>double&nbsp;</td>
          <td class="mdname" nowrap> <em>MatRueck</em>[3][3]</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00389">389</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00050">Boolean</a>, <a class="el" href="../../d3/d5/lh__open_2pi__app_8h-source.html#l00023">CMError</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00317">CombiMatrix()</a>, <a class="el" href="../../d1/d0/lh__core_2genluts_8c-source.html#l01324">Extract_TRC_Matrix()</a>, <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l01334">MakeGamut16or32ForMonitor()</a>, and <a class="el" href="../../d1/d5/lh__core_2memlink_8c-source.html#l00905">NormalizeWithWhiteAdaption()</a>.
<p>
<pre class="fragment"><div>00390 {
00391         <span class="keywordtype">double</span>  detm, hilf1, hilf2, hilf3, hilf4, hilf5, hilf6;
00392         <span class="keywordtype">double</span>  *a;
00393         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00394 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00395 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> err=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00396 <span class="preprocessor">#endif</span>
00397 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"doubMatrixInvert"</span>)
00398         a = (<span class="keywordtype">double</span> *)MatHin;
00399         
00400         hilf1 = a[0] * a[4];
00401         hilf2 = a[1] * a[5];
00402         hilf3 = a[2] * a[3];
00403         hilf4 = a[2] * a[4];
00404         hilf5 = a[1] * a[3];
00405         hilf6 = a[0] * a[5];
00406         
00407         detm = hilf1 * a[8] + hilf2 * a[6]
00408                  + hilf3 * a[7] - hilf4 * a[6]
00409                  - hilf5 * a[8] - hilf6 * a[7];
00410         
00411         <span class="comment">/*      if(fabs(detm) &lt; 1.E-9) */</span>
00412         if ( (detm &lt; 1.E-9) &amp;&amp; (detm &gt; -1.E-9) )
00413         success = FALSE;
00414         else
00415         {
00416                 detm = 1. / detm;
00417                 
00418                 MatRueck[0][0] = (a[4] * a[8] - a[5] * a[7]) * detm;
00419                 MatRueck[0][1] = (a[7] * a[2] - a[8] * a[1]) * detm;
00420                 MatRueck[0][2] = (hilf2       - hilf4      ) * detm;
00421         
00422                 MatRueck[1][0] = (a[5] * a[6] - a[3] * a[8]) * detm;
00423                 MatRueck[1][1] = (a[8] * a[0] - a[6] * a[2]) * detm;
00424                 MatRueck[1][2] = (hilf3       - hilf6      ) * detm;
00425         
00426                 MatRueck[2][0] = (a[3] * a[7] - a[4] * a[6]) * detm;
00427                 MatRueck[2][1] = (a[6] * a[1] - a[7] * a[0]) * detm;
00428                 MatRueck[2][2] = (hilf1       - hilf5      ) * detm;
00429         }
00430         
00431         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"doubMatrixInvert"</span>)
00432     return(success);
00433 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="w98/lh_core/fragment.c::Fill_byte_ALUTs_from_lut16Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_byte_ALUTs_from_lut16Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileALuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>outputTableEntries</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l01237">1237</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00043">ALLOC_DATA</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00040">CMLutParam::colorLutOutDim</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00038">DATA_2_PTR</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00045">DISPOSE_IF_DATA</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00041">LOCK_DATA</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00036">LUT_DATA_TYPE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00020">nil</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00071">OSErr</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00038">CMLutParam::outputLut</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00235">UINT16</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00030">UINT8</a>, and <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00042">UNLOCK_DATA</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/lh__core_2genluts_8c-source.html#l00830">Extract_MFT_Alut()</a>.
<p>
<pre class="fragment"><div>01241 {
01242         <span class="keywordtype">long</span>                    i, j;
01243         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curOutLut;
01244         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curALUT;
01245         <span class="keywordtype">long</span>                    count, clipIndex, outTabLen;
01246         <span class="keywordtype">long</span>                    indFactor, fract, baseInd, lAux;
01247         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *profALUTs = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)profileALuts;
01248         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01249         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01250         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *localAlutPtr;
01251         <span class="keywordtype">long</span>                    theAlutSize;
01252         
01253         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut16Tag"</span>)
01254         
01255         count     = 1 &lt;&lt; addrBits;                                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
01256         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8));    <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
01257 
01258         theAlutSize = theLutData-&gt;colorLutOutDim * count;
01259         localAlut   = ALLOC_DATA(theAlutSize + 1, &amp;err);
01260         if (err)
01261                 goto CleanupAndExit;
01262         
01263         outTabLen = outputTableEntries;                                 <span class="comment">/* &lt;= 4096 */</span>
01264         indFactor = ((outTabLen - 1) &lt;&lt; 18) / clipIndex;        <span class="comment">/* for adjusting the indices */</span>
01265         
01266         LOCK_DATA(localAlut);
01267         localAlutPtr = (UINT8*)DATA_2_PTR(localAlut);
01268         
01269         for(i=0; i&lt;theLutData-&gt;colorLutOutDim; i++)
01270         {
01271                 curOutLut = profALUTs + i * outTabLen;
01272                 curALUT   = localAlutPtr + i * count;
01273                 
01274                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex; j++)
01275                 {
01276                         lAux    = (j * indFactor+32) &gt;&gt; 6;
01277                         baseInd = lAux &gt;&gt; 12;
01278                         fract   = lAux &amp; 0x0FFF;
01279                         
01280                         <span class="keywordflow">if</span>(fract)
01281                         {
01282                                 lAux = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1] - (<span class="keywordtype">long</span>)curOutLut[baseInd];
01283                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
01284                                 
01285                                 curALUT[j] = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>)(((<span class="keywordtype">long</span>)curOutLut[baseInd] + lAux) &gt;&gt; 8);
01286                         }
01287                         <span class="keywordflow">else</span>
01288                                 curALUT[j] = curOutLut[baseInd] &gt;&gt; 8;
01289                 }
01290                 
01291                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
01292                         curALUT[j] = curALUT[clipIndex];
01293         }
01294         
01295         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
01296         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
01297         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01298 CleanupAndExit:
01299         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
01300         
01301         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut16Tag"</span>)
01302         return err;
01303 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="w98/lh_core/fragment.c::Fill_byte_ALUTs_from_lut8Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_byte_ALUTs_from_lut8Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileALuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l01028">1028</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00043">ALLOC_DATA</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00040">CMLutParam::colorLutOutDim</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00038">DATA_2_PTR</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00045">DISPOSE_IF_DATA</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00041">LOCK_DATA</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00036">LUT_DATA_TYPE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00020">nil</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00071">OSErr</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00038">CMLutParam::outputLut</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00030">UINT8</a>, and <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00042">UNLOCK_DATA</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/lh__core_2genluts_8c-source.html#l00830">Extract_MFT_Alut()</a>.
<p>
<pre class="fragment"><div>01031 {
01032         <span class="keywordtype">long</span>                    i, j;
01033         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curOutLut;
01034         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *profAluts = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)profileALuts;
01035         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curALUT;
01036         <span class="keywordtype">long</span>                    count, clipIndex;
01037         <span class="keywordtype">long</span>                    factor, fract, baseInd, lAux;
01038         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01039         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01040         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *localAlutPtr;
01041         <span class="keywordtype">long</span>                    theAlutSize;
01042         
01043         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut8Tag"</span>)
01044 
01045         count     = 1 &lt;&lt; addrBits;                                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
01046         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8));    <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
01047         
01048         theAlutSize = theLutData-&gt;colorLutOutDim * count;
01049         localAlut   = ALLOC_DATA(theAlutSize + 1, &amp;err);
01050         if (err)
01051                 goto CleanupAndExit;
01052         
01053         LOCK_DATA(localAlut);
01054         localAlutPtr = (UINT8*)DATA_2_PTR(localAlut);
01055         
01056         factor = (255 &lt;&lt; 12) / clipIndex;               <span class="comment">/* for adjusting the indices */</span>
01057         
01058         for(i=0; i&lt;theLutData-&gt;colorLutOutDim; i++)
01059         {
01060                 curOutLut = profAluts + (i &lt;&lt; 8);
01061                 curALUT   = localAlutPtr + i * count;
01062                 
01063                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex; j++)
01064                 {
01065                         lAux    = j * factor;
01066                         baseInd = lAux &gt;&gt; 12;
01067                         fract   = lAux &amp; 0x0FFF;
01068                         
01069                         <span class="keywordflow">if</span>(fract)
01070                         {
01071                                 lAux = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1] - (<span class="keywordtype">long</span>)curOutLut[baseInd];
01072                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
01073                                 
01074                                 curALUT[j] = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>)((<span class="keywordtype">long</span>)curOutLut[baseInd] + lAux);
01075                         }
01076                         <span class="keywordflow">else</span>
01077                                 curALUT[j] = curOutLut[baseInd];
01078                 }
01079                 
01080                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
01081                         curALUT[j] = curALUT[clipIndex];
01082         }
01083         
01084         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
01085         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
01086         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01087 CleanupAndExit:
01088         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
01089         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut8Tag"</span>)
01090         return err;
01091 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="w98/lh_core/fragment.c::Fill_inverse_byte_ALUT_from_CurveTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_inverse_byte_ALUT_from_CurveTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pCurveTag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>ucALUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00692">692</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d3/d5/lh__open_2pi__app_8h-source.html#l00023">CMError</a>, <a class="el" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a3">Fill_inverseGamma_byte_ALUT()</a>, <a class="el" href="../../d8/d3/aug98_2dll32_2icc_8h-source.html#l00217">icSigCurveType</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, and <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>.
<p>
<pre class="fragment"><div>00695 {
00696         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, inCount, outCount;
00697         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   intpFirst, intpLast, halfStep, ulAux, target;
00698         <span class="keywordtype">short</span>                   monot;
00699         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *inCurve, *usPtr, *stopPtr;
00700         <span class="keywordtype">double</span>                  flFactor;
00701         <span class="keywordtype">char</span>                    baseShift;
00702         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   clipIndex;
00703         <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                 err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00704 
00705         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_inverse_byte_ALUT_from_CurveTag"</span>)
00706 
00707     if( pCurveTag-&gt;base.sig != icSigCurveType   <span class="comment">/* 'curv' */</span>
00708      || addrBits &gt; 15 )
00709     {
00710 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00711 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( DebugCheck(kThisFile, kDebugErrorInfo) )
00712             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(<span class="stringliteral">"¥ Fill_inverse_byte_ALUT_from_CurveTag ERROR:  addrBits = %d\n"</span>,addrBits);
00713 <span class="preprocessor">#endif</span>
00714 <span class="preprocessor"></span>                err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00715                 <span class="keywordflow">goto</span> CleanupAndExit;
00716         }
00717         
00718         outCount = 0x1 &lt;&lt; addrBits;
00719 
00720                 <span class="comment">/*---special cases:---*/</span>
00721 
00722         <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 0)         <span class="comment">/*---identity---*/</span>
00723         {
00724                 baseShift = addrBits - 8;               <span class="comment">/* &gt;= 0, we need at least 256 values */</span>
00725                 
00726                 <span class="keywordflow">for</span>(i=0; i&lt;outCount; i++)
00727                         ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(i &gt;&gt; baseShift);
00728         
00729                 <span class="keywordflow">goto</span> CleanupAndExit;
00730         }
00731         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 1)    <span class="comment">/*---gamma curve---*/</span>
00732         {
00733                 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a3">Fill_inverseGamma_byte_ALUT</a>(ucALUT, addrBits, pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>[0]);
00734                 <span class="keywordflow">goto</span> CleanupAndExit;
00735         }
00736         
00737                 <span class="comment">/*---ordinary case:---*/</span>
00738         
00739         inCount = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a>;
00740         inCurve = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>;
00741                 
00742                  <span class="comment">/* exact matching factor needed for special values: */</span>
00743         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8)); <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
00744         flFactor  = (<span class="keywordtype">double</span>)clipIndex / 65535.;
00745         
00746         halfStep = outCount &gt;&gt; 1;               <span class="comment">/* lessen computation incorrectness */</span>
00747         
00748                                 <span class="comment">/* ascending or descending ? */</span>
00749         <span class="keywordflow">for</span>(monot=0, i=1; i&lt;inCount; i++)
00750         {
00751                 <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00752                         monot++;
00753                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00754                         monot--;
00755         }
00756         
00757         <span class="keywordflow">if</span>(monot &gt;= 0)  <span class="comment">/* curve seems to be ascending */</span>
00758         {
00759                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00760                         <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00761                                 inCurve[i] = inCurve[i-1];
00762                 
00763                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor + 0.9999);
00764                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor);
00765                 
00766                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00767                         ucALUT[i] = 0;
00768                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00769                         ucALUT[i] = 0xFF;
00770 
00771                         <span class="comment">/* interpolate remaining values: */</span>
00772                 usPtr   = inCurve;
00773                 stopPtr = inCurve + inCount - 2; <span class="comment">/* stops incrementation */</span>
00774                 
00775                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00776                 {
00777                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00778                         <span class="keywordflow">while</span>(*(usPtr+1) &lt; target &amp;&amp; usPtr &lt; stopPtr)
00779                                 usPtr++;                                        <span class="comment">/* find interval */</span>
00780                         
00781                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr - inCurve) &lt;&lt; 16) / (inCount - 1);
00782                         <span class="keywordflow">if</span>(*(usPtr+1) != *usPtr)
00783                         {
00784                                 ulAux += ((target - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*usPtr) &lt;&lt; 16)
00785                                           / ( (*(usPtr+1) - *usPtr) * (inCount - 1) );
00786                                 
00787                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)   <span class="comment">/* *(usPtr+1) was required */</span>
00788                                         ulAux = 0x0FFFF;
00789                         }
00790                         
00791                         ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(ulAux &gt;&gt; 8);
00792                 }
00793         }
00794         <span class="keywordflow">else</span>                    <span class="comment">/* curve seems to be descending */</span>
00795         {
00796                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00797                         <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00798                                 inCurve[i] = inCurve[i-1];
00799                 
00800                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor + 0.9999);
00801                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor);
00802                 
00803                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00804                         ucALUT[i] = 0xFF;
00805                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00806                         ucALUT[i] = 0;
00807 
00808                         <span class="comment">/* interpolate remaining values: */</span>
00809                 usPtr   = inCurve + inCount - 1;
00810                 stopPtr = inCurve + 1;          <span class="comment">/* stops decrementation */</span>
00811                 
00812                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00813                 {
00814                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00815                         <span class="keywordflow">while</span>(*(usPtr-1) &lt; target &amp;&amp; usPtr &gt; stopPtr)
00816                                 usPtr--;                                        <span class="comment">/* find interval */</span>
00817                         
00818                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr-1 - inCurve) &lt;&lt; 16) / (inCount - 1);
00819                         <span class="keywordflow">if</span>(*(usPtr-1) != *usPtr)
00820                         {
00821                                 ulAux += (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*(usPtr-1) - target) &lt;&lt; 16)
00822                                           / ( (*(usPtr-1) - *usPtr) * (inCount - 1) );
00823                                 
00824                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)
00825                                         ulAux = 0x0FFFF;
00826                         }
00827                         
00828             ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(ulAux &gt;&gt; 8);
00829                 }
00830         }
00831 
00832 CleanupAndExit: 
00833         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_inverse_byte_ALUT_from_CurveTag"</span>)
00834         return(noErr);
00835 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="w98/lh_core/fragment.c::Fill_inverseGamma_byte_ALUT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void Fill_inverseGamma_byte_ALUT           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>ucALUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>unsigned short&nbsp;</td>
          <td class="mdname" nowrap> <em>gamma_u8_8</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00692">Fill_inverse_byte_ALUT_from_CurveTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="w98/lh_core/fragment.c::Fill_ushort_ELUT_from_CurveTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUT_from_CurveTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pCurveTag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>usELUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00460">460</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d3/d5/lh__open_2pi__app_8h-source.html#l00023">CMError</a>, <a class="el" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00546">icCurve::count</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00767">icCurveType::curve</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00547">icCurve::data</a>, <a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a2">Fill_ushort_ELUT_Gamma()</a>, <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00558">Fill_ushort_ELUT_identical()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, and <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>.
<p>
<pre class="fragment"><div>00465 {
00466         <span class="keywordtype">long</span>                    i, count, indFactor, outFactor, baseInd, maxOut;
00467         <span class="keywordtype">long</span>                    fract, lAux, diff, outRound, outShift, interpRound, interpShift;
00468         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *usCurv;
00469         <span class="keywordtype">double</span>                  dFactor;
00470         <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                 err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00471         
00472         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_from_CurveTag"</span>)
00473                 <span class="comment">/*---special cases:---*/</span>
00474 
00475         if(pCurveTag-&gt;curve.count == 0)         <span class="comment">/* identity curve */</span>
00476         {
00477                 err = <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a3">Fill_ushort_ELUT_identical</a>(usELUT, addrBits, usedBits, gridPoints);
00478                 <span class="keywordflow">goto</span> CleanupAndExit;
00479         }
00480         
00481         <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 1)         <span class="comment">/* Gamma  curve */</span>
00482         {
00483                 err = <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a2">Fill_ushort_ELUT_Gamma</a>(usELUT, addrBits, usedBits, gridPoints, pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>[0]);
00484                 <span class="keywordflow">goto</span> CleanupAndExit;
00485         }
00486                 <span class="comment">/*---ordinary case:---*/</span>
00487         
00488         <span class="keywordflow">if</span>(addrBits &gt; 15)
00489         {
00490                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;       <span class="comment">/* would lead to overflow */</span>
00491                 <span class="keywordflow">goto</span> CleanupAndExit;
00492         }
00493         
00494         count     = 1 &lt;&lt; addrBits;
00495         indFactor = ((pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> - 1) &lt;&lt; 18) / (count - 1); <span class="comment">/* for adjusting indices */</span>
00496         
00497         <span class="keywordflow">if</span>(usedBits &lt; 8)
00498         {
00499                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00500                 <span class="keywordflow">goto</span> CleanupAndExit;
00501         }
00502         
00503         <span class="keywordflow">if</span>(gridPoints == 0)
00504                 maxOut = 65535;
00505         <span class="keywordflow">else</span>
00506                 maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00507         
00508                 <span class="comment">/*-----find factor for the values that fits in 15 bits------*/</span>
00509                 <span class="comment">/* (product with 16 bit number must fit in 31 bit uns.long)     */</span>
00510                 <span class="comment">/* n.b: 512 &lt;= maxOut &lt;= 65535  in all possible cases           */</span>
00511         
00512         dFactor  = (<span class="keywordtype">double</span>)maxOut / 65535.;             <span class="comment">/* 65535 is max. curve value */</span>
00513         dFactor *= 4194304.;                                    <span class="comment">/* same as &lt;&lt; 22, certainly too much */</span>
00514         
00515         outFactor = (<span class="keywordtype">long</span>)dFactor;
00516         outRound  = (1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; 21) - 1;
00517         outShift  = 22;
00518         <span class="keywordflow">while</span>(outFactor &amp; 0xFFF8000)    <span class="comment">/* stay within 15 bits to prevent product overflow */</span>
00519         {
00520                 outFactor &gt;&gt;= 1;
00521                 outRound  &gt;&gt;= 1;
00522                 outShift   -= 1;
00523         }
00524         
00525         interpRound = outRound &gt;&gt; 1;    <span class="comment">/* with interpolation we have an additional...  */</span>
00526         interpShift = outShift  - 1;    <span class="comment">/* ... &gt;&gt; 1 because we must add two nunmbers    */</span>
00527         
00528         usCurv = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>;
00529         
00530         <span class="keywordflow">for</span>(i=0; i&lt;count; i++)
00531         {
00532                 lAux    = (i * indFactor+4) &gt;&gt; 3;
00533                 baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 15;
00534                 fract   = lAux &amp; 0x7FFF;                <span class="comment">/* 15 bits for interpolation */</span>
00535                 
00536                 <span class="keywordflow">if</span>(fract)               <span class="comment">/* interpolation necessary ? */</span>
00537                 {
00538                         lAux = (<span class="keywordtype">long</span>)usCurv[baseInd] * outFactor &gt;&gt; 1;
00539                         
00540                         diff = (<span class="keywordtype">long</span>)usCurv[baseInd+1] - (<span class="keywordtype">long</span>)usCurv[baseInd];
00541                         diff = (diff * outFactor &gt;&gt; 15) * fract &gt;&gt; 1;
00542 
00543                         usELUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( (lAux + diff + interpRound) &gt;&gt; interpShift );
00544                 }
00545                 <span class="keywordflow">else</span>
00546                         usELUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( ((<span class="keywordtype">long</span>)usCurv[baseInd]
00547                                                                                                 * outFactor + outRound) &gt;&gt; outShift );
00548         }
00549 
00550 CleanupAndExit: 
00551         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_from_CurveTag"</span>)
00552         return(noErr);
00553 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="w98/lh_core/fragment.c::Fill_ushort_ELUT_Gamma" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUT_Gamma           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>usELUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>unsigned short&nbsp;</td>
          <td class="mdname" nowrap> <em>gamma_u8_8</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00460">Fill_ushort_ELUT_from_CurveTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="w98/lh_core/fragment.c::Fill_ushort_ELUT_identical" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUT_identical           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a7">UINT16</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>usELUT</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00558">558</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d3/d5/lh__open_2pi__app_8h-source.html#l00023">CMError</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, and <a class="el" href="../../d0/d7/udf_8h-source.html#l00235">UINT16</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00460">Fill_ushort_ELUT_from_CurveTag()</a>.
<p>
<pre class="fragment"><div>00562 {
00563         <span class="keywordtype">long</span>            i, count, factor, maxOut;
00564         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>          *myWPtr;
00565 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00566 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00567 <span class="preprocessor">#endif</span>
00568 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_identical"</span>)
00569                 
00570         count  = 1 &lt;&lt; addrBits;
00571         
00572         if(gridPoints == 0)
00573                 maxOut = 65535;
00574         else
00575                 maxOut = ((1L &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00576         
00577         factor = (maxOut &lt;&lt; 14) / (count - 1);
00578         
00579         myWPtr = usELUT;
00580         for(i=0; i&lt;count; i++)
00581                 *myWPtr++ = (UINT16)((i * factor + 0x2000) &gt;&gt; 14);
00582         
00583         LH_END_PROC("Fill_ushort_ELUT_identical")
00584         return(noErr);
00585 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="w98/lh_core/fragment.c::Fill_ushort_ELUTs_from_lut16Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUTs_from_lut16Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileELuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>inputTableEntries</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l01121">1121</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00043">ALLOC_DATA</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00039">CMLutParam::colorLutInDim</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00038">DATA_2_PTR</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00045">DISPOSE_IF_DATA</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00035">CMLutParam::inputLut</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00041">LOCK_DATA</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00036">LUT_DATA_TYPE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00020">nil</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00071">OSErr</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00235">UINT16</a>, and <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00042">UNLOCK_DATA</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/lh__core_2genluts_8c-source.html#l00512">Extract_MFT_Elut()</a>.
<p>
<pre class="fragment"><div>01127 {
01128         <span class="keywordtype">long</span>                    i, j, inTabLen, maxOut;
01129         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curInLut;
01130         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curELUT;
01131         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *profELUT = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)profileELuts;
01132         <span class="keywordtype">long</span>                    count, outFactor, fract, lAux, diff;
01133         <span class="keywordtype">long</span>                    baseInd, indFactor;
01134         <span class="keywordtype">long</span>                    outRound, outShift, interpRound, interpShift;
01135         <span class="keywordtype">double</span>                  dFactor;
01136         <span class="keywordtype">long</span>                    theElutSize;
01137         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01138         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *localElutPtr;
01139         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01140 
01141         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut16Tag"</span>)
01142         
01143         count     = 1 &lt;&lt; addrBits;
01144         inTabLen  = inputTableEntries;
01145 
01146         theElutSize = theLutData-&gt;colorLutInDim * count * sizeof (UINT16);
01147         localElut   = ALLOC_DATA(theElutSize + 2, &amp;err);
01148         if(err)
01149                 goto CleanupAndExit;
01150         
01151         indFactor = ((inTabLen - 1) &lt;&lt; 18) / (count - 1);       <span class="comment">/* for adjusting indices */</span>
01152 
01153         if(gridPoints == 0)
01154                 maxOut = 65535;
01155         else
01156                 maxOut = ((1L &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
01157 
01158                 <span class="comment">/*-----find factor for the values that fits in 15 bits------*/</span>
01159                 <span class="comment">/* (product with 16 bit number must fit in 31 bit uns.long)     */</span>
01160                 <span class="comment">/* n.b: 512 &lt;= maxOut &lt;= 65535  in all possible cases           */</span>
01161         
01162         dFactor  = (<span class="keywordtype">double</span>)maxOut / 65535.;             <span class="comment">/* 65535 is max. curve value */</span>
01163         dFactor *= 4194304.;                                    <span class="comment">/* same as &lt;&lt; 22, certainly too much */</span>
01164         
01165         outFactor = (<span class="keywordtype">long</span>)dFactor;
01166         outRound  = (1L &lt;&lt; 21) - 1;
01167         outShift  = 22;
01168         while(outFactor &amp; 0xFFF8000)    <span class="comment">/* stay within 15 bits to prevent product overflow */</span>
01169         {
01170                 outFactor &gt;&gt;= 1;
01171                 outRound  &gt;&gt;= 1;
01172                 outShift   -= 1;
01173         }
01174         
01175         interpRound = outRound &gt;&gt; 1;    <span class="comment">/* with interpolation we have an additional...  */</span>
01176         interpShift = outShift  - 1;    <span class="comment">/* ... &gt;&gt; 1 because we must add two nunmbers    */</span>
01177         
01178         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localElut);
01179         localElutPtr = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localElut);
01180 
01181         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o6">colorLutInDim</a>; i++)
01182         {
01183                 curInLut = profELUT + (i * inTabLen);
01184                 curELUT  = localElutPtr + (i * count);
01185 
01186                 <span class="keywordflow">for</span>(j=0; j&lt;count; j++)
01187                 {
01188                         lAux    = (j * indFactor+4) &gt;&gt; 3;
01189                         baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 15;
01190                         fract   = lAux &amp; 0x7FFF;        <span class="comment">/* 15 bits for interpolation */</span>
01191 
01192                         <span class="keywordflow">if</span>(fract)               <span class="comment">/* interpolation necessary ? */</span>
01193                         {
01194                                 lAux = (<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor &gt;&gt; 1;
01195                                 
01196                                 diff = (<span class="keywordtype">long</span>)curInLut[baseInd+1] - (<span class="keywordtype">long</span>)curInLut[baseInd];
01197                                 diff = ((diff * outFactor &gt;&gt; 15) * fract) &gt;&gt; 1;
01198 
01199                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( (lAux + diff + interpRound) &gt;&gt; interpShift );
01200                         }
01201                         <span class="keywordflow">else</span>
01202                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( ((<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor
01203                                                                                                         + outRound) &gt;&gt; outShift );
01204                 }
01205         }
01206         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localElut);
01207         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a> = localElut;
01208         localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01209 CleanupAndExit: 
01210         localElut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localElut); 
01211         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut16Tag"</span>)
01212         return err;
01213 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="w98/lh_core/fragment.c::Fill_ushort_ELUTs_from_lut8Tag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> Fill_ushort_ELUTs_from_lut8Tag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>profileELuts</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>addrBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char&nbsp;</td>
          <td class="mdname" nowrap> <em>usedBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>long&nbsp;</td>
          <td class="mdname" nowrap> <em>gridPoints</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00941">941</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00043">ALLOC_DATA</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00039">CMLutParam::colorLutInDim</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00038">DATA_2_PTR</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00045">DISPOSE_IF_DATA</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00035">CMLutParam::inputLut</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00041">LOCK_DATA</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00036">LUT_DATA_TYPE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00020">nil</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00071">OSErr</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00235">UINT16</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00030">UINT8</a>, and <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00042">UNLOCK_DATA</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/lh__core_2genluts_8c-source.html#l00512">Extract_MFT_Elut()</a>.
<p>
<pre class="fragment"><div>00946 {
00947         <span class="keywordtype">long</span>                    i, j, maxOut;
00948         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curInLut;
00949         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curELUT;
00950         <span class="keywordtype">long</span>                    count, indFactor, outFactor, baseInd, fract, lAux, diff;
00951         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00952         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *localElutPtr;
00953         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00954         <span class="keywordtype">long</span>                    theElutSize;
00955         
00956         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut8Tag"</span>)
00957         
00958         count       = 1 &lt;&lt; addrBits;
00959         theElutSize = theLutData-&gt;colorLutInDim * count * sizeof (UINT16);
00960         localElut   = ALLOC_DATA(theElutSize + 2, &amp;err);
00961         if (err)
00962                 goto CleanupAndExit;
00963         
00964         indFactor = (255 &lt;&lt; 12) / (count - 1);  <span class="comment">/* for adjusting indices */</span>
00965         
00966         if(gridPoints == 0)
00967                 maxOut = 65535;
00968         else
00969                 maxOut = ((1L &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00970         outFactor = (maxOut &lt;&lt; 12) / 255;                       <span class="comment">/* 255 is max. value from mft1 output lut */</span>
00971         
00972         LOCK_DATA(localElut);
00973         localElutPtr = (UINT16*)DATA_2_PTR(localElut);
00974         for(i=0; i&lt;theLutData-&gt;colorLutInDim; i++)
00975         {
00976                 curInLut = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)profileELuts + (i &lt;&lt; 8);
00977                 curELUT  = localElutPtr + i * count;
00978                 
00979                 <span class="keywordflow">for</span>(j=0; j&lt;count; j++)
00980                 {
00981                         lAux    = j * indFactor;
00982                         baseInd = lAux &gt;&gt; 12;
00983                         fract   = (lAux &amp; 0x0FFF) &gt;&gt; 4; <span class="comment">/* leaves 8 bits for interpolation as with distortion */</span>
00984 
00985                         <span class="keywordflow">if</span>(fract &amp;&amp; baseInd != 255)             <span class="comment">/* interpolation necessary ? */</span>
00986                         {
00987                                 lAux = (<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor &gt;&gt; 6;
00988                                 
00989                                 diff = (<span class="keywordtype">long</span>)curInLut[baseInd+1] - (<span class="keywordtype">long</span>)curInLut[baseInd];
00990                                 diff = (diff * outFactor &gt;&gt; 6) * fract &gt;&gt; 8;
00991 
00992                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( (lAux + diff + 32) &gt;&gt; 6 );
00993                         }
00994                         <span class="keywordflow">else</span>
00995                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( ((<span class="keywordtype">long</span>)curInLut[baseInd]
00996                                                                                                         * outFactor + 0x0800) &gt;&gt; 12 );
00997                 }
00998         }
00999         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localElut);
01000         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a> = localElut;
01001         localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01002 CleanupAndExit:
01003         localElut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localElut);
01004         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut8Tag"</span>)
01005         return err;
01006 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="w98/lh_core/fragment.c::InvertLut1d" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a>* InvertLut1d           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structicCurveType.html">icCurveType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>LookUpTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AdressBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l00070">70</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00766">icCurveType::base</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00546">icCurve::count</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00767">icCurveType::curve</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00547">icCurve::data</a>, <a class="el" href="../../d8/d3/aug98_2dll32_2icc_8h-source.html#l00217">icSigCurveType</a>, <a class="el" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a1">InvLut1dExceptions()</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00020">nil</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00071">OSErr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00070">OSType</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00761">icTagBase::reserved</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00760">icTagBase::sig</a>, and <a class="el" href="../../d7/d6/lh__open_2pi__mem_8c-source.html#l00047">SmartNewPtr()</a>.
<p>
<pre class="fragment"><div>00072 {
00073         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, inCount, outCount;
00074         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   intpFirst, intpLast, halfStep, ulAux, target;
00075         <span class="keywordtype">short</span>                   monot;
00076         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *inCurve, *outCurve, *usPtr, *stopPtr;
00077         <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a>             *outCMcurve = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00078         <span class="keywordtype">double</span>                  flFactor;
00079         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00080         
00081         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"InvertLut1d"</span>)
00082         
00083         if( LookUpTable-&gt;base.sig != icSigCurveType     <span class="comment">/* 'curv' */</span> || AdressBits &gt; 15 )
00084                 goto CleanupAndExit;
00085         
00086         inCount  = LookUpTable-&gt;curve.count;
00087         inCurve  = LookUpTable-&gt;curve.data;
00088         outCount = 0x1 &lt;&lt; AdressBits;
00089                 
00090         outCMcurve = (<a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a> *)SmartNewPtr( sizeof(OSType)
00091                                                                           + 2 * sizeof(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)
00092                                                                           + outCount * sizeof(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), &amp;err );
00093         if(err)
00094                 goto CleanupAndExit;
00095         
00096         outCurve = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)outCMcurve-&gt;curve.data;
00097         
00098         outCMcurve-&gt;base.sig    = icSigCurveType;       <span class="comment">/* 'curv' */</span>
00099         outCMcurve-&gt;base.reserved[0] = 0x00;
00100         outCMcurve-&gt;base.reserved[1] = 0x00;
00101         outCMcurve-&gt;base.reserved[2] = 0x00;
00102         outCMcurve-&gt;base.reserved[3] = 0x00;
00103         outCMcurve-&gt;curve.count = outCount;
00104         
00105         if(inCount &lt; 2)         <span class="comment">/* 0 or 1 point in LUT */</span>
00106         {
00107                 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a1">InvLut1dExceptions</a>(inCurve, inCount, outCurve, AdressBits);
00108                 <span class="keywordflow">goto</span> CleanupAndExit;
00109         }
00110         
00111                  <span class="comment">/* exact matching factor for special values: */</span>
00112         flFactor = (<span class="keywordtype">double</span>)(outCount - 1) / 65535.;
00113         halfStep = outCount &gt;&gt; 1;               <span class="comment">/* lessen computation incorrectness */</span>
00114         
00115                                 <span class="comment">/* ascending or descending ? */</span>
00116         <span class="keywordflow">for</span>(monot=0, i=1; i&lt;inCount; i++)
00117         {
00118                 <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00119                         monot++;
00120                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00121                         monot--;
00122         }
00123         
00124         <span class="keywordflow">if</span>(monot &gt;= 0)  <span class="comment">/* curve seems to be ascending */</span>
00125         {
00126                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00127                         <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00128                                 inCurve[i] = inCurve[i-1];
00129                 
00130                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor + 0.9999);
00131                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor);
00132                 
00133                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00134                         outCurve[i] = 0;
00135                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00136                         outCurve[i] = 0xFFFF;
00137 
00138                         <span class="comment">/* interpolate remaining values: */</span>
00139                 usPtr   = inCurve;
00140                 stopPtr = inCurve + inCount - 2; <span class="comment">/* stops incrementation */</span>
00141                 
00142                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00143                 {
00144                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00145                         <span class="keywordflow">while</span>(*(usPtr+1) &lt; target &amp;&amp; usPtr &lt; stopPtr)
00146                                 usPtr++;                                        <span class="comment">/* find interval */</span>
00147                         
00148                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr - inCurve) &lt;&lt; 16) / (inCount - 1);
00149                         <span class="keywordflow">if</span>(*(usPtr+1) != *usPtr)
00150                         {
00151                                 ulAux += ((target - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*usPtr) &lt;&lt; 16)
00152                                           / ( (*(usPtr+1) - *usPtr) * (inCount - 1) );
00153                                 
00154                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)   <span class="comment">/* *(usPtr+1) was required */</span>
00155                                         ulAux = 0xFFFF;
00156                         }
00157                         
00158                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00159                 }
00160         }
00161         <span class="keywordflow">else</span>                    <span class="comment">/* curve seems to be descending */</span>
00162         {
00163                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00164                         <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00165                                 inCurve[i] = inCurve[i-1];
00166                 
00167                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor + 0.9999);
00168                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor);
00169                 
00170                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00171                         outCurve[i] = 0xFFFF;
00172                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00173                         outCurve[i] = 0;
00174 
00175                         <span class="comment">/* interpolate remaining values: */</span>
00176                 usPtr   = inCurve + inCount - 1;
00177                 stopPtr = inCurve + 1;          <span class="comment">/* stops decrementation */</span>
00178                 
00179                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00180                 {
00181                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00182                         <span class="keywordflow">while</span>(*(usPtr-1) &lt; target &amp;&amp; usPtr &gt; stopPtr)
00183                                 usPtr--;                                        <span class="comment">/* find interval */</span>
00184                         
00185                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr-1 - inCurve) &lt;&lt; 16) / (inCount - 1);
00186                         <span class="keywordflow">if</span>(*(usPtr-1) != *usPtr)
00187                         {
00188                                 ulAux += (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*(usPtr-1) - target) &lt;&lt; 16)
00189                                           / ( (*(usPtr-1) - *usPtr) * (inCount - 1) );
00190                                 
00191                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)
00192                                         ulAux = 0x0FFFF;
00193                         }
00194                         
00195                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00196                 }
00197         }
00198 CleanupAndExit:
00199         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"InvertLut1d"</span>)
00200         return(outCMcurve);
00201 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="w98/lh_core/fragment.c::InvLut1dExceptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void InvLut1dExceptions           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>inCurve</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>unsigned long&nbsp;</td>
          <td class="mdname" nowrap> <em>inCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>outCurve</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a6">UINT8</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AdressBits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00070">InvertLut1d()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="w98/lh_core/fragment.c::MakeGamut16or32ForMonitor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/w98_2lh__open_2pi__app_8h.html#a11">CMError</a> MakeGamut16or32ForMonitor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pRedXYZ</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pGreenXYZ</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/structicXYZType.html">icXYZType</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pBlueXYZ</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>theLutData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a21">Boolean</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cube32Flag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html#l01334">1334</a> of file <a class="el" href="../../d1/d6/w98_2lh__core_2fragment_8c-source.html">w98/lh_core/fragment.c</a>.
<p>
References <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00066">adr_bereich_alut</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00061">adr_bereich_elut</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00043">ALLOC_DATA</a>, <a class="el" href="../../d3/d5/lh__open_2pi__app_8h-source.html#l00023">CMError</a>, <a class="el" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00043">CMLutParam::colorLut</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00541">icXYZArray::data</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00887">icXYZType::data</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00038">DATA_2_PTR</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00045">DISPOSE_IF_DATA</a>, <a class="el" href="../../d0/d6/lh__core_2fragment_8c-source.html#l00389">doubMatrixInvert()</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00035">CMLutParam::inputLut</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00053">LH_END_PROC</a>, <a class="el" href="../../d7/d8/lh__open_2general_8h-source.html#l00052">LH_START_PROC</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00041">LOCK_DATA</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00036">LUT_DATA_TYPE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00020">nil</a>, <a class="el" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00071">OSErr</a>, <a class="el" href="../../d5/d6/w98_2lh__core_2typedefs_8h-source.html#l00038">CMLutParam::outputLut</a>, <a class="el" href="../../d6/d5/lh__core_2defines_8h-source.html#l00042">UNLOCK_DATA</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00534">icXYZNumber::X</a>, <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00535">icXYZNumber::Y</a>, and <a class="el" href="../../d6/d6/mscmm_8w98_2lh__core_2profile_8h-source.html#l00536">icXYZNumber::Z</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/lh__core_2genluts_8c-source.html#l00380">DoMakeGamutForMonitor()</a>.
<p>
<pre class="fragment"><div>01340 {
01341         <span class="keywordtype">double</span>                  XYZmatrix[3][3], RGBmatrix[3][3];
01342         <span class="keywordtype">double</span>                  sum, dFactor;
01343         <span class="keywordtype">long</span>                    i, j, k, gridPoints, planeCount, totalCount, longMat[9];
01344         <span class="keywordtype">long</span>                    longX, longY, longZ, longR, longG, longB;
01345         <span class="keywordtype">long</span>                    *lPtr, lFactor, maxOut;
01346         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *usPtr;
01347         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *XPtr;
01348         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempXLutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01349         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempELutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01350         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempALutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01351         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *tempXLut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01352         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *tempALut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01353         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *tempELut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01354         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  Levels[32];
01355         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01356         
01357         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"MakeGamut16or32ForMonitor"</span>)
01358         
01359         if(theLutData-&gt;inputLut != nil || theLutData-&gt;colorLut != nil || theLutData-&gt;outputLut != nil)
01360         {
01361                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
01362                 <span class="keywordflow">goto</span> CleanupAndExit;
01363         }
01364         
01365         <span class="comment">/*----------------------------------------------------------------------------------------- E */</span>
01366         tempELutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(256 * 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), &amp;err);
01367         <span class="keywordflow">if</span>(err)
01368                 <span class="keywordflow">goto</span> CleanupAndExit;
01369         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempELutHdl);
01370         tempELut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempELutHdl);
01371 
01372         <span class="comment">/*----------------------------------------------------------------------------------------- X */</span>
01373         <span class="keywordflow">if</span>(cube32Flag)
01374                 gridPoints = 32;                        <span class="comment">/* for cube grid */</span>
01375         <span class="keywordflow">else</span>
01376                 gridPoints = 16;
01377         totalCount = gridPoints * gridPoints * gridPoints;
01378 
01379         tempXLutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(totalCount, &amp;err);
01380         <span class="keywordflow">if</span>(err)
01381                 <span class="keywordflow">goto</span> CleanupAndExit;
01382         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempXLutHdl);
01383         tempXLut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempXLutHdl);
01384         
01385         <span class="comment">/*----------------------------------------------------------------------------------------- A */</span>
01386         tempALutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(adr_bereich_alut, &amp;err);
01387         <span class="keywordflow">if</span>(err)
01388                 <span class="keywordflow">goto</span> CleanupAndExit;
01389         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempALutHdl);
01390         tempALut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempALutHdl);
01391         
01392                 <span class="comment">/*---------fill 3 ELUTs for X, Y, Z (256 u.shorts each):--------------------*/</span>
01393                 <span class="comment">/* linear curve with clipping, slope makes white value  become                          */</span>
01394                 <span class="comment">/* max * 30.5/31 or max * 14.5/15, that is half of the last XLUT interval       */</span>
01395         <span class="keywordflow">if</span>(cube32Flag)
01396                 dFactor = 30.5 / 31.;
01397         <span class="keywordflow">else</span>
01398                 dFactor = 14.5 / 15.;
01399         
01400         maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (16 <span class="comment">/*usedBits*/</span> - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
01401         
01402         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)              <span class="comment">/* X, Y, Z ELUTs */</span>
01403         {
01404                 <span class="keywordflow">if</span>(i == 0)
01405                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255. / 0.9642 );<span class="comment">/* X, adjust D50 */</span>
01406                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(i == 1)
01407                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255.);                 <span class="comment">/* Y */</span>
01408                 <span class="keywordflow">else</span>
01409                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255. / 0.8249);<span class="comment">/* Z, adjust D50 */</span>
01410                 
01411                 usPtr = tempELut + 256 * i;
01412                 <span class="keywordflow">for</span>(j=0; j&lt;256; j++)
01413                 {
01414                         k = (j * lFactor + 127) &gt;&gt; 8;
01415                         <span class="keywordflow">if</span>(k &gt; maxOut)
01416                                 k = maxOut;             <span class="comment">/* max. ELUT value */</span>
01417                         
01418                         *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)k;
01419                 }
01420         }
01421 
01422                 <span class="comment">/*------ RGB to XYZ matrix in the range 0.0 to 1.0 -----*/</span>
01423                 <span class="comment">/* floating point for accurate inversion                                */</span>
01424         XYZmatrix[0][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01425         XYZmatrix[1][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01426         XYZmatrix[2][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01427 
01428         XYZmatrix[0][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01429         XYZmatrix[1][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01430         XYZmatrix[2][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01431 
01432         XYZmatrix[0][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01433         XYZmatrix[1][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01434         XYZmatrix[2][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01435         
01436                 <span class="comment">/*--- grey with R = G = B (D50 adjustment is done by the ELUTs) ----*/</span>
01437         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)
01438         {
01439                 sum = XYZmatrix[i][0] + XYZmatrix[i][1] + XYZmatrix[i][2];
01440                 <span class="keywordflow">if</span>(sum &lt; 0.1)
01441                         sum = 0.1;      <span class="comment">/* prevent from div. by 0 (bad profiles) */</span>
01442                 
01443                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
01444                         XYZmatrix[i][j] /= sum;
01445         }
01446         
01447                 <span class="comment">/*---XYZ to RGB matrix:---*/</span>
01448         <span class="keywordflow">if</span>(!<a class="code" href="../../d1/d6/w98_2lh__core_2memlink_8c.html#a24">doubMatrixInvert</a>(XYZmatrix, RGBmatrix))
01449         {
01450                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
01451                 <span class="keywordflow">goto</span> CleanupAndExit;
01452         }
01453         
01454         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)                              <span class="comment">/* create integer format for speed, */</span>
01455                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)                      <span class="comment">/* 1.0 becomes 2^13, works for coeff. up to 8. */</span>
01456                         longMat[3*i + j] = (<span class="keywordtype">long</span>)(RGBmatrix[i][j] * 8192.);
01457         
01458                 <span class="comment">/*-----grid levels for cube grid in XYZ (16 bit) so ----*/</span>
01459                 <span class="comment">/* that white is at half of last interval, so the last  */</span>
01460                 <span class="comment">/* value is white * 15/14.5 or white * 31/30.5                  */</span>
01461         <span class="keywordflow">if</span>(cube32Flag)
01462                 dFactor = 32768. / 30.5 * 31. / (gridPoints - 1);
01463         <span class="keywordflow">else</span>
01464                 dFactor = 32768. / 14.5 * 15. / (gridPoints - 1);
01465 
01466         <span class="keywordflow">for</span>(i=0; i&lt;gridPoints; i++)                     <span class="comment">/* n.b: 32 is max. possible gridPoints */</span>
01467                 Levels[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(i * dFactor + 0.5);
01468         
01469                 <span class="comment">/*----special treatment of first and last plane for speed:----*/</span>
01470         planeCount = gridPoints * gridPoints;
01471         XPtr       = tempXLut;
01472         <span class="keywordflow">for</span>(i=0; i&lt;planeCount; i++)
01473                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01474         
01475         XPtr = tempXLut + (gridPoints - 1) * planeCount;
01476         <span class="keywordflow">for</span>(i=0; i&lt;planeCount; i++)
01477                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01478         
01479         *tempXLut = 0;  <span class="comment">/* set black (white is between last 2 planes) */</span>
01480 
01481                 <span class="comment">/*----second to second last plane must be computed:-----*/</span>
01482                 <span class="comment">/*  transform points to RGB and judge in/out                    */</span>
01483         XPtr = tempXLut + planeCount;
01484                 
01485         <span class="keywordflow">for</span>(i=1; i&lt;gridPoints-1; i++)
01486                 <span class="keywordflow">for</span>(j=0; j&lt;gridPoints; j++)
01487                         <span class="keywordflow">for</span>(k=0; k&lt;gridPoints; k++)
01488                         {
01489                                 longX = (<span class="keywordtype">long</span>)Levels[i];                <span class="comment">/* X */</span>
01490                                 longY = (<span class="keywordtype">long</span>)Levels[j];                <span class="comment">/* Y */</span>
01491                                 longZ = (<span class="keywordtype">long</span>)Levels[k];                <span class="comment">/* Z */</span>
01492                                 
01493                                         <span class="comment">/* matrix coeff: 2^13 is 1.0 , XYZ values: 1.0 or 100. is 2^15 ;        */</span>
01494                                         <span class="comment">/* -&gt; mask for products &lt; 0 and &gt;= 2^28 is used for in/out checking     */</span>
01495                                 
01496                                 longR = longX * longMat[0] + longY * longMat[1] + longZ * longMat[2];
01497                                 <span class="keywordflow">if</span>(longR &amp; 0xF0000000)
01498                                         *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01499                                 <span class="keywordflow">else</span>
01500                                 {
01501                                         longG = longX * longMat[3] + longY * longMat[4] + longZ * longMat[5];
01502                                         <span class="keywordflow">if</span>(longG &amp; 0xF0000000)
01503                                                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01504                                         <span class="keywordflow">else</span>
01505                                         {
01506                                                 longB = longX * longMat[6] + longY * longMat[7] + longZ * longMat[8];
01507                                                 <span class="keywordflow">if</span>(longB &amp; 0xF0000000)
01508                                                         *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01509                                                 <span class="keywordflow">else</span>
01510                                                         *XPtr++ = 0;            <span class="comment">/* in gamut */</span>
01511                                         }
01512                                 }
01513                         }
01514         
01515                 <span class="comment">/*---fill Boolean output LUT, adr_bereich_alut Bytes, 4 at one time with long:---*/</span>
01516         lPtr = (<span class="keywordtype">long</span> *)(tempALut);
01517         j = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a21">adr_bereich_alut</a>/4/2 + 8;   <span class="comment">/* slightly more than 50 % */</span>
01518         <span class="keywordflow">for</span>(i=0; i&lt;j; i++)                              <span class="comment">/* slightly more than 50 % */</span>
01519                 *(lPtr + i) = 0;                        <span class="comment">/* in gamut */</span>
01520         k = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a21">adr_bereich_alut</a>/4;
01521         <span class="keywordflow">for</span>(i=j; i&lt;k; i++)
01522                 *(lPtr + i) = 0xFFFFFFFF;       <span class="comment">/* out of gamut */</span>
01523         
01524         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempELutHdl);
01525         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempXLutHdl);
01526         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempALutHdl);
01527         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o10">colorLut</a>    = tempXLutHdl;  tempXLutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01528         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a>    = tempELutHdl;  tempELutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01529         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a>   = tempALutHdl;  tempALutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01530         
01531 CleanupAndExit:
01532         tempELutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempELutHdl);
01533         tempXLutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempXLutHdl);
01534         tempALutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempALutHdl);
01535         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"MakeGamut16or32ForMonitor"</span>)
01536         return (err);
01537 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
